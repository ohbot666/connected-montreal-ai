<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üéØ Connected Montreal ‚Äî AI Mission Control</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: #0a0a0f; color: #e0e0e0;
    font-family: 'SF Mono', 'JetBrains Mono', 'Fira Code', monospace;
    height: 100vh; display: flex; flex-direction: column; overflow: hidden;
  }
  
  .topbar {
    background: #111118; border-bottom: 1px solid #1e1e2e;
    padding: 14px 20px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
  }
  
  .topbar-title {
    font-size: 15px; font-weight: 700; color: #fff; display: flex; align-items: center; gap: 8px;
  }
  
  .topbar-title span.time {
    font-size: 11px; color: #888; font-weight: 400; margin-left: 16px;
  }
  
  .status-indicators {
    display: flex; gap: 12px; font-size: 10px; align-items: center;
  }
  
  .status-dot {
    width: 6px; height: 6px; border-radius: 50%; display: inline-block; margin-right: 4px;
  }
  
  .status-dot.online { background: #22c55e; }
  .status-dot.offline { background: #cc0000; }
  .status-dot.idle { background: #f0a500; }
  
  .status-indicator {
    display: flex; align-items: center; gap: 4px; padding: 4px 8px; background: rgba(255,255,255,.05); border-radius: 4px; color: #aaa;
  }
  
  .main-content {
    display: flex; flex: 1; overflow: hidden; gap: 0;
  }
  
  .column {
    flex: 1; display: flex; flex-direction: column; overflow: auto; border-right: 1px solid #1e1e2e;
    padding: 16px; background: rgba(10,10,15,.5);
  }
  
  .column:last-child { border-right: none; }
  
  .section {
    margin-bottom: 20px;
  }
  
  .section-title {
    font-size: 10px; letter-spacing: 2px; text-transform: uppercase; color: #666;
    margin-bottom: 10px; display: flex; align-items: center; gap: 6px;
  }
  
  .section-title::before {
    content: '‚ñ∂'; font-size: 8px; color: #444;
  }
  
  /* PIPELINE SECTION */
  .pipeline-funnel {
    display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; margin-bottom: 12px;
  }
  
  .funnel-stage {
    background: #111118; border: 1px solid #1e1e2e; border-radius: 6px; padding: 12px; text-align: center;
  }
  
  .funnel-stage.active {
    background: #15120a; border-color: #f0a500;
  }
  
  .funnel-label {
    font-size: 9px; color: #666; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;
  }
  
  .funnel-count {
    font-size: 18px; font-weight: 700; color: #fff; margin-bottom: 2px;
  }
  
  .funnel-stage.active .funnel-count {
    color: #f0a500;
  }
  
  .big-metric {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 1px solid #2a2a4a;
    border-radius: 8px; padding: 14px; margin-bottom: 12px; text-align: center;
  }
  
  .big-metric-label {
    font-size: 9px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px;
  }
  
  .big-metric-value {
    font-size: 28px; font-weight: 700; color: #22c55e; letter-spacing: -1px;
  }
  
  .metric-sub {
    font-size: 10px; color: #666; margin-top: 3px;
  }
  
  /* LEADS TABLE */
  .leads-list {
    background: #111118; border: 1px solid #1e1e2e; border-radius: 6px; overflow: hidden; font-size: 10px;
  }
  
  .leads-list-header {
    background: #0a0a0f; border-bottom: 1px solid #1e1e2e; padding: 8px 10px;
    display: grid; grid-template-columns: 1fr 80px 60px; gap: 8px; font-weight: 600; color: #666; text-transform: uppercase; letter-spacing: 0.5px;
  }
  
  .leads-list-row {
    border-bottom: 1px solid #1a1a2a; padding: 8px 10px; display: grid;
    grid-template-columns: 1fr 80px 60px; gap: 8px; align-items: center;
    transition: background .2s;
  }
  
  .leads-list-row:last-child { border-bottom: none; }
  .leads-list-row:hover { background: rgba(255,255,255,.02); }
  
  .lead-name { color: #e0e0e0; font-weight: 500; }
  .lead-status { color: #888; font-size: 9px; }
  .lead-days {
    padding: 2px 6px; border-radius: 3px; background: rgba(200,0,0,.1); color: #ff6b6b; font-size: 9px; text-align: center; font-weight: 600;
  }
  
  .lead-days.recent { background: rgba(34,197,94,.1); color: #4ade80; }
  .lead-days.very-recent { background: rgba(34,197,94,.2); color: #22c55e; }
  
  /* TRAFFIC SECTION */
  .traffic-metric {
    background: #111118; border: 1px solid #1e1e2e; border-radius: 6px; padding: 10px; margin-bottom: 8px;
  }
  
  .traffic-metric-label { font-size: 9px; color: #666; text-transform: uppercase; letter-spacing: 1px; }
  .traffic-metric-value { font-size: 16px; font-weight: 700; color: #fff; margin-top: 4px; }
  .traffic-metric-sub { font-size: 9px; color: #666; margin-top: 2px; }
  
  .sources-list {
    background: #111118; border: 1px solid #1e1e2e; border-radius: 6px; font-size: 10px; overflow: hidden;
  }
  
  .source-row {
    border-bottom: 1px solid #1a1a2a; padding: 8px 10px; display: flex; justify-content: space-between; align-items: center;
  }
  
  .source-row:last-child { border-bottom: none; }
  .source-name { color: #ccc; flex: 1; }
  .source-count { color: #f0a500; font-weight: 600; }
  
  .source-bar {
    width: 40px; height: 3px; background: rgba(240,165,0,.3); border-radius: 2px; margin-left: 8px; display: inline-block;
  }
  
  /* INSIGHTS SECTION */
  .insight-card {
    background: #111118; border: 1px solid #1e1e2e; border-radius: 6px; padding: 10px; margin-bottom: 8px; border-left: 3px solid #1e1e2e;
  }
  
  .insight-card.opportunity { border-left-color: #22c55e; background: rgba(34,197,94,.05); }
  .insight-card.issue { border-left-color: #cc0000; background: rgba(204,0,0,.05); }
  .insight-card.alert { border-left-color: #f0a500; background: rgba(240,165,0,.05); }
  
  .insight-icon { font-size: 12px; margin-right: 4px; }
  .insight-text { font-size: 10px; line-height: 1.4; color: #ccc; }
  .insight-card.opportunity .insight-text { color: #4ade80; }
  .insight-card.issue .insight-text { color: #ff6b6b; }
  .insight-card.alert .insight-text { color: #fbbf24; }
  
  .pending-approvals {
    background: linear-gradient(135deg, rgba(58,95,255,.1) 0%, rgba(58,95,255,.05) 100%); border: 1px solid rgba(58,95,255,.2);
    border-radius: 6px; padding: 10px; margin-bottom: 8px; font-size: 10px;
  }
  
  .pending-approvals-label { color: #7a8fff; font-weight: 600; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 1px; }
  .pending-approvals-item { color: #5a7aff; font-size: 9px; margin-bottom: 4px; }
  
  .action-buttons {
    display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px;
  }
  
  .action-btn {
    background: #1e1e2e; color: #7a8fff; border: 1px solid #2a2a4a;
    padding: 8px 12px; border-radius: 6px; font-size: 10px; cursor: pointer; font-family: inherit;
    text-align: center; transition: all .2s; font-weight: 600; letter-spacing: 0.5px;
  }
  
  .action-btn:hover {
    background: #2a2a4a; border-color: #3a5fff; color: #fff; box-shadow: 0 0 10px rgba(58,95,255,.2);
  }
  
  /* DATE RANGE SELECTOR */
  .date-range-selector {
    display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap;
  }
  
  .date-btn {
    background: #1e1e2e; color: #999; border: 1px solid #2a2a4a;
    padding: 6px 10px; border-radius: 4px; font-size: 9px; cursor: pointer; font-family: inherit;
    transition: all .2s; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase;
  }
  
  .date-btn:hover {
    background: #252530; border-color: #333;
  }
  
  .date-btn.active {
    background: #f0a500; color: #000; border-color: #f0a500;
  }
  
  .custom-date-inputs {
    display: none; gap: 4px; margin-bottom: 12px;
  }
  
  .custom-date-inputs.show {
    display: flex;
  }
  
  .custom-date-inputs input {
    background: #1e1e2e; color: #e0e0e0; border: 1px solid #2a2a4a;
    padding: 6px 8px; border-radius: 4px; font-size: 9px; font-family: inherit;
  }
  
  .custom-date-inputs input::placeholder {
    color: #555;
  }
  
  .custom-date-inputs button {
    background: #f0a500; color: #000; border: none;
    padding: 6px 10px; border-radius: 4px; font-size: 9px; cursor: pointer; font-weight: 600;
    transition: all .2s;
  }
  
  .custom-date-inputs button:hover {
    background: #ffb81c;
  }
  
  .loading-indicator {
    display: inline; color: #f0a500; font-style: italic; font-size: 9px;
  }
  
  .error-message {
    display: none; background: rgba(204,0,0,.1); border: 1px solid rgba(204,0,0,.2);
    border-radius: 4px; padding: 8px; margin-bottom: 8px; font-size: 9px; color: #ff6b6b;
  }
  
  .error-message.show {
    display: block;
  }
  
  /* EXPANDABLE LISTS */
  .expandable-list {
    position: relative;
  }
  
  .list-items {
    overflow: hidden;
  }
  
  .list-items.collapsed {
    max-height: 200px;
  }
  
  .list-items.expanded {
    max-height: none;
  }
  
  .list-toggle {
    display: flex; justify-content: center; align-items: center; padding: 8px 10px;
    border-top: 1px solid #1a1a2a; color: #666; font-size: 9px; cursor: pointer;
    transition: all .2s; font-weight: 600;
  }
  
  .list-toggle:hover {
    color: #f0a500; background: rgba(240,165,0,.05);
  }
  
  .toggle-icon {
    display: inline-block; margin-right: 4px; font-size: 8px;
  }
  
  /* PROPOSALS SECTION */
  .proposals-summary {
    background: linear-gradient(135deg, rgba(58,95,255,.1) 0%, rgba(58,95,255,.05) 100%);
    border: 1px solid rgba(58,95,255,.2); border-radius: 6px; padding: 10px;
    margin-bottom: 8px; font-size: 10px; cursor: pointer;
    transition: all .2s; display: flex; justify-content: space-between; align-items: center;
  }
  
  .proposals-summary:hover {
    background: linear-gradient(135deg, rgba(58,95,255,.15) 0%, rgba(58,95,255,.1) 100%);
    border-color: rgba(58,95,255,.3);
  }
  
  .proposals-summary-text {
    color: #7a8fff; font-weight: 600; display: flex; align-items: center; gap: 6px;
  }
  
  .proposals-summary-toggle {
    font-size: 10px; color: #7a8fff;
  }
  
  .proposals-list {
    display: none;
  }
  
  .proposals-list.show {
    display: block;
  }
  
  .proposal-card {
    background: #111118; border: 1px solid #1e1e2e; border-left: 3px solid #1e1e2e;
    border-radius: 6px; padding: 10px; margin-bottom: 8px; font-size: 10px;
    transition: all .2s;
  }
  
  .proposal-card:hover {
    background: #151520; border-color: rgba(255,255,255,.05);
  }
  
  .proposal-card.high {
    border-left-color: #ff6b6b; background: rgba(204,0,0,.05);
  }
  
  .proposal-card.medium {
    border-left-color: #fbbf24; background: rgba(251,191,36,.05);
  }
  
  .proposal-header {
    display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px;
  }
  
  .proposal-priority {
    display: inline-block; padding: 2px 6px; border-radius: 3px; font-size: 8px;
    font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
  }
  
  .proposal-priority.high {
    background: rgba(204,0,0,.2); color: #ff6b6b;
  }
  
  .proposal-priority.medium {
    background: rgba(251,191,36,.2); color: #fbbf24;
  }
  
  .proposal-issue {
    color: #ccc; line-height: 1.3; margin-bottom: 8px; display: -webkit-box;
    -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
  }
  
  .proposal-action {
    display: flex; justify-content: flex-end;
  }
  
  .proposal-btn {
    background: #1e1e2e; color: #7a8fff; border: 1px solid #2a2a4a;
    padding: 4px 8px; border-radius: 4px; font-size: 9px; cursor: pointer; font-family: inherit;
    transition: all .2s; font-weight: 600;
  }
  
  .proposal-btn:hover {
    background: #2a2a4a; border-color: #3a5fff; color: #fff; box-shadow: 0 0 8px rgba(58,95,255,.2);
  }
  
  .bottombar {
    background: #111118; border-top: 1px solid #1e1e2e; padding: 12px 20px;
    display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;
    font-size: 10px; color: #666;
  }
  
  .bottombar-left {
    display: flex; gap: 20px; align-items: center;
  }
  
  .bottombar-right {
    display: flex; gap: 10px; align-items: center;
  }
  
  .refresh-btn {
    background: #1e1e2e; color: #7a8fff; border: 1px solid #2a2a4a;
    padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 10px; font-family: inherit;
    transition: all .2s;
  }
  
  .refresh-btn:hover {
    background: #2a2a4a; border-color: #3a5fff; color: #fff;
  }
  
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: #444; }
  
  .mobile-tab-bar { display: none; }
  
  @media (max-width: 768px) {
    .mobile-tab-bar {
      display: flex;
      position: sticky;
      top: 0;
      z-index: 200;
      background: #0a0a0f;
      border-bottom: 1px solid #1e1e2e;
      padding: 0;
    }
    .mobile-tab-btn {
      flex: 1;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      color: #666;
      padding: 10px 4px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .mobile-tab-btn.active {
      color: #22c55e;
      border-bottom-color: #22c55e;
    }
    [data-tab] { display: none !important; }
    [data-tab].tab-active { display: block !important; }
    /* Jay chat ‚Äî taller + touch-friendly on mobile */
    [id^="jay-msgs-"] { max-height: 280px !important; }
    [id^="jay-"] input[type="text"] { font-size: 16px !important; padding: 10px 12px !important; }
    [id^="jay-"] button { padding: 10px 14px !important; font-size: 13px !important; }
    /* SMS thread ‚Äî taller on mobile */
    [id^="sms-thread-"] { max-height: 280px !important; }
    [id^="sms-"] input[type="text"] { font-size: 16px !important; padding: 10px 12px !important; }
  }
  
  /* Responsive */
  @media (max-width: 1400px) {
    .column { padding: 12px; }
    .topbar { padding: 10px 14px; }
    .topbar-title { font-size: 13px; }
  }
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-title">
    üéØ Connected Montreal ‚Äî AI Mission Control
    <span class="time" id="lastUpdatedTime">Last updated: 2m ago</span>
  </div>
  <div class="status-indicators">
    <div class="status-indicator">
      <span class="status-dot online"></span> PostHog
    </div>
    <div class="status-indicator">
      <span class="status-dot online"></span> Analytics
    </div>
    <div class="status-indicator">
      <span class="status-dot online"></span> Airtable
    </div>
    <div class="status-indicator">
      <span class="status-dot idle"></span> Google Ads
    </div>
  </div>
</div>

<div class="mobile-tab-bar">
  <button class="mobile-tab-btn active" onclick="switchTab('pipeline', this)">üìã Pipeline</button>
  <button class="mobile-tab-btn" onclick="switchTab('traffic', this)">üìà Traffic</button>
  <button class="mobile-tab-btn" onclick="switchTab('intel', this)">üí° Intel</button>
</div>

<div class="main-content">
  
  <!-- COLUMN 1: LEAD PIPELINE -->
  <div class="column" id="col1" data-tab="pipeline">
    <div class="section" style="padding-bottom:8px;">
      <div style="position:relative;">
        <input id="client-search" type="text" placeholder="üîç Search all clients..." autocomplete="off"
          style="width:100%;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.15);border-radius:6px;color:#fff;padding:9px 12px;font-size:12px;box-sizing:border-box;"
          oninput="searchClients(this.value)" onfocus="searchClients(this.value)"/>
        <div id="client-search-results" style="display:none;position:absolute;top:100%;left:0;right:0;background:#111118;border:1px solid #1e1e2e;border-radius:0 0 6px 6px;z-index:100;max-height:200px;overflow-y:auto;margin-top:2px;"></div>
      </div>
      <div id="client-search-card" style="margin-top:8px;"></div>
    </div>
    <div class="section">
      <div class="section-title">Pipeline Funnel</div>
      <div class="pipeline-funnel">
        <div class="funnel-stage">
          <div class="funnel-label">New</div>
          <div class="funnel-count" id="pipeline-new">4</div>
        </div>
        <div class="funnel-stage active">
          <div class="funnel-label">Quoted</div>
          <div class="funnel-count" id="pipeline-quoted">29</div>
        </div>
        <div class="funnel-stage">
          <div class="funnel-label">Booked</div>
          <div class="funnel-count" id="pipeline-booked">0</div>
        </div>
        <div class="funnel-stage">
          <div class="funnel-label">No-Go</div>
          <div class="funnel-count" id="pipeline-nogo">0</div>
        </div>
      </div>
    </div>
    

    
    <div class="section">
      <div class="section-title">This Week</div>
      <div class="traffic-metric">
        <div class="traffic-metric-label">New Leads</div>
        <div class="traffic-metric-value" id="new-leads-7d">15</div>
        <div class="traffic-metric-sub">7-day total</div>
      </div>
    </div>
    
    <div class="section">
      <div class="section-title">New Requests</div>
      <div style="background: rgba(34,197,94,.1); border: 1px solid rgba(34,197,94,.2); border-radius: 6px; padding: 8px; margin-bottom: 10px;">
        <div id="new-requests-count" style="font-size: 16px; font-weight: 700; color: #4ade80;">‚Äî</div>
        <div style="font-size: 9px; color: #4ade80; margin-top: 2px;">new requests waiting for contact</div>
      </div>
      <div class="leads-list">
        <div class="leads-list-header" style="grid-template-columns: 1fr 50px 70px;">
          <div>Name</div>
          <div>Pax</div>
          <div>Date</div>
        </div>
        <div id="new-requests-rows"></div>
      </div>
    </div>
    
    <div class="section">
      <div class="section-title">Follow-ups Needed</div>
      <div style="background: rgba(200,0,0,.1); border: 1px solid rgba(204,0,0,.2); border-radius: 6px; padding: 8px; margin-bottom: 10px;">
        <div style="font-size: 16px; font-weight: 700; color: #ff6b6b;" id="followup-count">10</div>
        <div style="font-size: 9px; color: #ff6b6b; margin-top: 2px;">leads waiting for contact</div>
      </div>
      
      <div class="leads-list">
        <div class="leads-list-header">
          <div>Name</div>
          <div>Status</div>
          <div>Days</div>
        </div>
        <div id="leads-list-rows"></div>
      </div>
    </div>
  </div>
  
  <!-- COLUMN 2: TRAFFIC & ENGAGEMENT -->
  <div class="column" id="col2" data-tab="traffic">
    <div class="section">
      <div class="section-title">Traffic & Pageviews</div>
      
      <!-- Date Range Selector -->
      <div class="date-range-selector">
        <button class="date-btn" data-range="1d" onclick="fetchTrafficData('1d')">1D</button>
        <button class="date-btn active" data-range="7d" onclick="fetchTrafficData('7d')">7D</button>
        <button class="date-btn" data-range="30d" onclick="fetchTrafficData('30d')">1M</button>
        <button class="date-btn" data-range="custom" onclick="toggleCustomDateInput()">Custom</button>
      </div>
      
      <div class="custom-date-inputs" id="custom-date-inputs">
        <input type="date" id="custom-from" placeholder="From">
        <input type="date" id="custom-to" placeholder="To">
        <button onclick="fetchTrafficDataCustom()">Load</button>
      </div>
      
      <div class="error-message" id="traffic-error"></div>
      
      <div class="traffic-metric">
        <div class="traffic-metric-label">Total Pageviews <span id="traffic-period">(7d)</span></div>
        <div class="traffic-metric-value" id="total-pageviews">795</div>
        <div class="traffic-metric-sub">Avg <strong id="avg-pageviews">113.6</strong>/day</div>
      </div>
    </div>
    
    <div class="section">
      <div class="section-title">Traffic Sources</div>
      <div class="expandable-list">
        <div class="sources-list">
          <div class="list-items collapsed" id="sources-list"></div>
          <div class="list-toggle" onclick="toggleList('sources-list')">
            <span class="toggle-icon">‚ñº</span>
            <span id="sources-toggle-text">Show more</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="section">
      <div class="section-title">Top Pages</div>
      <div class="expandable-list">
        <div class="sources-list">
          <div class="list-items collapsed" id="top-pages-list"></div>
          <div class="list-toggle" onclick="toggleList('top-pages-list')">
            <span class="toggle-icon">‚ñº</span>
            <span id="top-pages-toggle-text">Show more</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="section">
      <div class="section-title">Ad Landing Pages</div>
      <div class="expandable-list">
        <div class="sources-list">
          <div class="list-items collapsed" id="ad-pages-list"></div>
          <div class="list-toggle" onclick="toggleList('ad-pages-list')">
            <span class="toggle-icon">‚ñº</span>
            <span id="ad-pages-toggle-text">Show more</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- COLUMN 3: AI INSIGHTS & ACTIONS -->
  <div class="column" id="col3" data-tab="intel">
    <div class="section">
      <div class="section-title">Opportunities</div>
      <div id="opportunities-list"></div>
    </div>
    
    <div class="section">
      <div class="section-title">Issues & Alerts</div>
      <div id="issues-list"></div>
    </div>
    
    <div class="section">
      <div class="section-title">Pending Approvals</div>
      
      <div class="proposals-summary" onclick="toggleProposals()">
        <div class="proposals-summary-text">
          <span>üí° AI Recommendations ‚Äî <strong id="proposals-count">5</strong> pending</span>
        </div>
        <div class="proposals-summary-toggle" id="proposals-toggle-icon">‚ñº Show</div>
      </div>
      
      <div class="proposals-list" id="proposals-list"></div>
    </div>
    
    <div class="section">
      <div class="section-title">Quick Actions</div>
      <div class="action-buttons">
        <button class="action-btn" onclick="alert('Opening Google Ads dashboard‚Ä¶')">üìä View Ads</button>
        <button class="action-btn" onclick="alert('Launching analysis‚Ä¶')">üîç Run Analysis</button>
        <button class="action-btn" onclick="alert('Generating report‚Ä¶')">üìÑ Generate Report</button>
        <button class="action-btn" onclick="alert('Opening leads CRM‚Ä¶')">üë• CRM</button>
      </div>
    </div>
  </div>
  
</div>

<div class="bottombar">
  <div class="bottombar-left">
    <span>üìÖ Report generated: <strong id="generated-time">Feb 26, 1:31 PM</strong></span>
    <span>üì° Data freshness: <strong style="color: #22c55e;">live</strong></span>
  </div>
  <div class="bottombar-right">
    <button class="refresh-btn" onclick="location.reload()">üîÑ Refresh Data</button>
  </div>
</div>

<script>
// Embedded data from JSON files
const DAILY_REPORT = {
  "generated_at": "2026-02-26T13:31:17.332407",
  "period_days": 7,
  "posthog": {
    "top_pages": [
      {"url": "/", "views": 177},
      {"url": "/bachelor-party-a-v2/", "views": 67},
      {"url": "/bachelor-party-packages/", "views": 58},
      {"url": "/itinerary-first-ballot-hall-of-famer/", "views": 39},
      {"url": "/the-ultimate-montreal-strip-clubs-guide/", "views": 32},
      {"url": "/blogs/austin-brewery-distillery-crawl-bachelor-party", "views": 26},
      {"url": "/montreal-bachelor-party-a/", "views": 23},
      {"url": "/activities", "views": 21},
      {"url": "/itinerary-bros-and-respectable-ladies/", "views": 21},
      {"url": "/itineraries", "views": 17}
    ],
    "traffic_sources": [
      {"source": "www.google.com", "sessions": 323},
      {"source": "$direct", "sessions": 244},
      {"source": "connectedmontreal.com", "sessions": 148},
      {"source": "www.connectedaustin.com", "sessions": 47},
      {"source": "www.reddit.com", "sessions": 20},
      {"source": "com.google.android.googlequicksearchbox", "sessions": 3},
      {"source": "youtube.com", "sessions": 2},
      {"source": "www.bing.com", "sessions": 2}
    ],
    "total_pageviews_7d": 795,
    "avg_daily_pageviews": 113.6,
    "ad_landing_pages": [
      {"url": "/bachelor-party-a-v2/", "views": 39},
      {"url": "/", "views": 38},
      {"url": "/bachelor-party-packages/", "views": 27},
      {"url": "/montreal-bachelor-party-a/", "views": 9},
      {"url": "/itinerary-first-ballot-hall-of-famer/", "views": 9}
    ]
  },
  "airtable": {
    "new_leads_7d": 15,
    "pipeline": {
      "new": 4,
      "quoted": 29,
      "booked": 0,
      "no_go": 0
    },
    "leads_needing_followup": [
      {"name": "Sam Klassen", "status": "talked to/ quoted", "last_contact": "2026-02-24", "id": "rec03Da9JkhAbH7oU"},
      {"name": "Jordan Elist", "status": "talked to/ quoted", "last_contact": "2026-01-06", "id": "rec2CySjgaPaqsgM4"},
      {"name": "Stephen Napier", "status": "talked to/ quoted", "last_contact": "2026-01-19", "id": "rec5ZN8rpNOCToEj9"},
      {"name": "Seth Walker", "status": "talked to/ quoted", "last_contact": "2026-01-30", "id": "rec5oxBUHzFZrZ1ug"},
      {"name": "Bryson Hipkin", "status": "talked to/ quoted", "last_contact": "2026-02-12", "id": "rec5rvupr3mMNp6g4"},
      {"name": "Dennis Joseph", "status": "talked to/ quoted", "last_contact": "2026-02-24", "id": "rec6QLGXHg6UWUA11"},
      {"name": "Shaw Poetker", "status": "talked to/ quoted", "last_contact": "2026-02-23", "id": "rec8Ep2oyXzZdW9wd"},
      {"name": "Kris Aarts", "status": "talked to/ quoted", "last_contact": "2026-02-19", "id": "recEKOCFMT3Xb1cNO"},
      {"name": "Aatish Jamal", "status": "talked to/ quoted", "last_contact": "2026-02-16", "id": "recIR6epQqrw2DAHS"},
      {"name": "Chris C", "status": "talked to/ quoted", "last_contact": "2026-01-26", "id": "recKAjL8BDlDJCnPp"}
    ],
    "new_requests": [
      {"name": "Trish Villanueva", "doa": "2026-05-08", "people": 11, "id": "recEqgDkebGqpMezN"},
      {"name": "John Atell", "doa": "2026-05-28", "people": 16, "id": "recSjYS9RHeF3O77X"},
      {"name": "Bennett Kuruvilla", "doa": "2027-05-28", "people": 20, "id": "recVaP1p1vb7BARcu"},
      {"name": "Rohit M", "doa": "2020-05-16", "people": 15, "id": "recgnpf0RiOJYTCjz"},
      {"name": "Patrich Zulueta", "doa": "2026-06-04", "people": 14, "id": "recwkCS9VYG8En6S3"}
    ],
    "total_pipeline_value": 7495171.65
  },
  "insights": {
    "issues": ["No critical issues detected"],
    "opportunities": [
      "Top ad landing page: /bachelor-party-a-v2/ (39 ad clicks)",
      "29 leads currently in quoted stage ‚Äî close them",
      "$7,495,172 in active pipeline value"
    ]
  }
};

const PROPOSALS = {
  "proposals": [
    {
      "id": "low-conversion-ad-landing-1",
      "priority": "high",
      "issue": "Ad landing page /bachelor-party-a-v2/ gets 39 clicks/week but only 15 new leads in 7 days (conversion rate ~12%)",
      "solution": "A/B test landing page: social proof, improved headline, simplified CTA, FAQ section"
    },
    {
      "id": "zero-closes-quoted-2",
      "priority": "high",
      "issue": "29 leads quoted, 0 booked. Quote-to-close rate is 0%.",
      "solution": "Launch 'Close-the-Loop' sprint: follow-up template, Day 3 & 7 outreach, value-add upgrades"
    },
    {
      "id": "followup-backlog-3",
      "priority": "high",
      "issue": "10 leads waiting for followup (4 overdue by 2+ weeks). Blocking pipeline movement.",
      "solution": "Clear backlog this week: tier leads A/B/C, call overdue contacts, implement Day 7/14 auto-followup"
    },
    {
      "id": "homepage-bounce-4",
      "priority": "medium",
      "issue": "Homepage dominates traffic (177 views) but 1% conversion rate suggests high bounce.",
      "solution": "Redesign for depth: social proof section, testimonials, itinerary carousel, blog links"
    },
    {
      "id": "seo-gap-5",
      "priority": "medium",
      "issue": "Direct traffic (244 sessions) vs Google (326) = weak organic ranking",
      "solution": "SEO quick wins: schema markup, 3 blog posts, internal linking, Core Web Vitals audit"
    }
  ]
};

// Render functions
function renderPipeline() {
  const p = DAILY_REPORT.airtable.pipeline;
  document.getElementById('pipeline-new').textContent = p.new;
  document.getElementById('pipeline-quoted').textContent = p.quoted;
  document.getElementById('pipeline-booked').textContent = p.booked;
  document.getElementById('pipeline-nogo').textContent = p.no_go;
  
  
  
  document.getElementById('new-leads-7d').textContent = DAILY_REPORT.airtable.new_leads_7d;
  
  const leads = DAILY_REPORT.airtable.leads_needing_followup;
  document.getElementById('followup-count').textContent = leads.length;
  
  const today = new Date('2026-02-26');
  const rows = document.getElementById('leads-list-rows');
  rows.innerHTML = '';
  
  leads.forEach(lead => {
    const lastContact = new Date(lead.last_contact);
    const daysAgo = Math.floor((today - lastContact) / (1000 * 60 * 60 * 24));
    let cssClass = '';
    if (daysAgo <= 3) cssClass = 'very-recent';
    else if (daysAgo <= 7) cssClass = 'recent';
    
    const row = document.createElement('div');
    row.className = 'leads-list-row';
    row.innerHTML = `
      <div class="lead-name"><a href="https://airtable.com/appHT9Re4l53GO16t/tbl4P7tqdonXv5vcY/${lead.id}" target="_blank" style="color:#e0e0e0;text-decoration:none;">${lead.name}</a></div>
      <div class="lead-status">quoted</div>
      <div class="lead-days ${cssClass}">${daysAgo}d</div>
    `;
    rows.appendChild(row);
  });
}

// Store full data for expandable lists
let expandableData = {
  sources: DAILY_REPORT.posthog.traffic_sources,
  pages: DAILY_REPORT.posthog.top_pages,
  adPages: DAILY_REPORT.posthog.ad_landing_pages
};

function renderNewRequests() {
  const rows = document.getElementById('new-requests-rows');
  if (!rows) return;
  const requests = DAILY_REPORT.airtable.new_requests || [];
  rows.innerHTML = requests.map(r => {
    const d = new Date(r.doa);
    const dateStr = d.toLocaleDateString('en-US', {month: 'short', day: 'numeric'});
    return `<div class="leads-list-row" style="grid-template-columns: 1fr 50px 70px;">
      <div class="lead-name"><a href="https://airtable.com/appHT9Re4l53GO16t/tbl4P7tqdonXv5vcY/${r.id}" target="_blank" style="color:#4ade80;text-decoration:none;">${r.name}</a></div>
      <div class="lead-status">${r.people} pax</div>
      <div class="lead-days very-recent">${dateStr}</div>
    </div>`;
  }).join('');
}

// Render lead cards from API data
let allLeads = [];

let searchTimer = null;
function searchClients(query) {
  const results = document.getElementById('client-search-results');
  if (!query.trim()) { results.style.display = 'none'; return; }
  results.innerHTML = '<div style="padding:8px 12px;color:#555;font-size:11px;font-style:italic;">Searching...</div>';
  results.style.display = 'block';
  clearTimeout(searchTimer);
  searchTimer = setTimeout(async () => {
    try {
      const r = await fetch('/api/search-clients?q=' + encodeURIComponent(query));
      const d = await r.json();
      if (!d.ok || !d.results.length) { results.innerHTML = '<div style="padding:8px 12px;color:#555;font-size:11px;">No results</div>'; return; }
      const statusColors = {'New Request':'#60a5fa','talked to/ quoted':'#fbbf24','Booked':'#4ade80','No Go':'#ff6b6b','No Go - Coming to Town':'#ff6b6b','No Go - Not Coming to Town':'#ff6b6b'};
      d.results.forEach(l => searchCache[l.id] = l);
      results.innerHTML = d.results.map(l => {
        const name = `${l.first_name} ${l.last_name}`.trim();
        const color = statusColors[l.status] || '#888';
        return `<div onclick="selectClient('${l.id}')" style="padding:8px 12px;cursor:pointer;border-bottom:1px solid #1e1e2e;display:flex;justify-content:space-between;align-items:center;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='none'">
          <span style="color:#fff;font-size:12px;">${l.flag||''} ${name}</span>
          <span style="color:${color};font-size:10px;">${l.status}</span>
        </div>`;
      }).join('');
    } catch(e) {
      results.innerHTML = '<div style="padding:8px 12px;color:#ff6b6b;font-size:11px;">Search failed</div>';
    }
  }, 300);
}

const searchCache = {};
function selectClient(id, leadData) {
  if (leadData) searchCache[id] = leadData;
  const lead = searchCache[id] || allLeads.find(l => l.id === id);
  if (!lead) return;
  document.getElementById('client-search-results').style.display = 'none';
  document.getElementById('client-search').value = `${lead.first_name} ${lead.last_name}`.trim();

  const name = `${lead.first_name} ${lead.last_name}`.trim();
  const flag = lead.flag || '';
  const doa = lead.doa ? new Date(lead.doa).toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'}) : 'TBD';
  const people = lead.people ? `${lead.people} people` : 'TBD';
  const phone = lead.phone || '';
  const grandTotal = lead.grand_total ? '$' + Number(lead.grand_total).toLocaleString('en-US',{maximumFractionDigits:0}) : '‚Äî';
  const statusColors = {'New Request':'rgba(96,165,250,0.2)','talked to/ quoted':'rgba(251,191,36,0.15)','Booked':'rgba(74,222,128,0.15)','No Go':'rgba(255,107,107,0.15)'};
  const borderColors = {'New Request':'rgba(96,165,250,0.4)','talked to/ quoted':'rgba(251,191,36,0.3)','Booked':'rgba(74,222,128,0.3)','No Go':'rgba(255,107,107,0.3)'};
  const bg = statusColors[lead.status] || 'rgba(255,255,255,0.05)';
  const border = borderColors[lead.status] || 'rgba(255,255,255,0.1)';
  const qqDoa = lead.doa ? (()=>{ const d=new Date(lead.doa); return String(d.getMonth()+1).padStart(2,'0')+'/'+String(d.getDate()).padStart(2,'0')+'/'+d.getFullYear(); })() : '';
  const qqUrl = 'https://airtable.com/appHT9Re4l53GO16t/shriG53J9mKJvNZ2a?prefill_Contact='+encodeURIComponent(name)+'&prefill_DOAText='+encodeURIComponent(qqDoa)+'&prefill_Nights='+(lead.nights||2)+'&prefill_People='+(lead.people||'')+'&prefill_CreateEssentialServices=Yes';
  const defaultMsg = `Hey ${lead.first_name}! This is Oren at Connected Montreal, got your request let me know when you're free to talk about the trip.`;

  const cardId = 'search-' + id;
  document.getElementById('client-search-card').innerHTML = `
    <div style="background:${bg};border:1px solid ${border};border-radius:8px;padding:12px;position:relative;" class="lead-card">
      <button onclick="document.getElementById('client-search-card').innerHTML='';document.getElementById('client-search').value='';" title="Close" style="position:absolute;top:6px;right:6px;background:none;border:none;color:#555;font-size:16px;cursor:pointer;line-height:1;padding:2px 4px;">‚úï</button>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;padding-right:20px;">
        <div style="font-weight:700;color:#fff;font-size:13px;cursor:pointer;" onclick="toggleExpand('${cardId}')">${flag} ${name} <span id="expand-arrow-${cardId}" style="font-size:10px;color:#666;">‚ñº</span></div>
        <div style="display:flex;gap:4px;align-items:center;">
          <a href="https://airtable.com/appHT9Re4l53GO16t/tbl4P7tqdonXv5vcY/${id}" target="_blank" style="color:#aaa;text-decoration:none;font-size:14px;padding:2px 4px;">‚Üó</a>
          ${lead.status==='New Request'?`<a href="${qqUrl}" target="_blank" style="background:rgba(251,191,36,0.15);border:1px solid rgba(251,191,36,0.3);border-radius:3px;color:#fbbf24;font-size:9px;font-weight:700;padding:2px 5px;text-decoration:none;">QQ</a>`:''}
          <button onclick="openItinerary('${id}')" title="View Itinerary" style="background:none;border:none;cursor:pointer;font-size:15px;padding:2px 4px;">üìÅ</button>
          <button onclick="toggleJay('s-${id}')" title="Ask Jay" style="background:none;border:none;cursor:pointer;font-size:16px;padding:2px 4px;">ü§ñ</button>
          <button onclick="toggleSMS('s-${id}','${phone}')" title="Send SMS" style="background:none;border:none;cursor:pointer;font-size:16px;padding:2px 4px;">üí¨</button>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:11px;color:#aaa;margin-bottom:6px;">
        <div>üìÖ <span style="color:#4ade80;">${doa}</span></div>
        <div>üë• <span style="color:#4ade80;">${people}</span></div>
        <div>üí∞ <span style="color:#4ade80;">${grandTotal}</span></div>
        <div>üìã <span style="color:#888;">${lead.status}</span></div>
      </div>
      <div id="expand-${cardId}" data-record-id="${id}" data-client-name="${name}" style="display:none;margin-top:8px;border-top:1px solid rgba(255,255,255,0.08);padding-top:8px;font-size:11px;">
        <div style="margin-bottom:6px;">üìû <span style="color:#fff;">${phone||'‚Äî'}</span></div>
        ${lead.notes?`<div style="color:#ccc;line-height:1.5;white-space:pre-wrap;font-size:11px;">${lead.notes.replace(/</g,'&lt;').substring(0,400)}</div>`:'<div style="color:#555;font-style:italic;">No notes.</div>'}
        <div id="itinerary-${cardId}"></div>
      </div>
      <div id="sms-s-${id}" style="display:none;margin-top:10px;border-top:1px solid rgba(255,255,255,0.1);padding-top:10px;">
        <div id="sms-thread-s-${id}" style="max-height:180px;overflow-y:auto;margin-bottom:8px;display:flex;flex-direction:column;gap:4px;"></div>
        <div style="display:flex;gap:6px;align-items:flex-end;">
          <input id="sms-text-s-${id}" type="text" placeholder="${defaultMsg}"
            style="flex:1;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.2);border-radius:18px;color:#fff;padding:8px 12px;font-size:12px;"
            onkeydown="if(event.key==='Enter')sendSMS('s-${id}','${phone}')"/>
          <button onclick="sendSMS('s-${id}','${phone}')" style="background:#4ade80;border:none;border-radius:50%;color:#000;width:32px;height:32px;font-size:16px;cursor:pointer;">‚Üë</button>
        </div>
        <span id="sms-status-s-${id}" style="font-size:10px;color:#aaa;display:block;margin-top:4px;"></span>
      </div>
      <div id="jay-s-${id}" style="display:none;margin-top:10px;border-top:1px solid rgba(99,102,241,0.3);padding-top:10px;">
        <div style="font-size:10px;color:#6366f1;font-weight:600;margin-bottom:6px;text-transform:uppercase;letter-spacing:1px;">ü§ñ Jay</div>
        <div id="jay-msgs-s-${id}" style="max-height:180px;overflow-y:auto;margin-bottom:8px;display:flex;flex-direction:column;gap:5px;"></div>
        <div style="display:flex;gap:6px;">
          <input id="jay-input-s-${id}" type="text" placeholder="Ask Jay about this client..."
            style="flex:1;background:rgba(99,102,241,0.1);border:1px solid rgba(99,102,241,0.3);border-radius:4px;color:#fff;padding:6px 8px;font-size:11px;"
            onkeydown="if(event.key==='Enter')askJay('s-${id}','Client: ${name} | ${lead.status} | DOA: ${doa} | People: ${people}')"/>
          <button onclick="askJay('s-${id}','Client: ${name} | ${lead.status} | DOA: ${doa} | People: ${people}')" style="background:#6366f1;border:none;border-radius:4px;color:#fff;padding:6px 10px;font-size:11px;font-weight:700;cursor:pointer;">Ask</button>
        </div>
      </div>
    </div>`;

  // Hide results dropdown on outside click
  document.addEventListener('click', function hideSearch(e) {
    if (!e.target.closest('#client-search') && !e.target.closest('#client-search-results')) {
      document.getElementById('client-search-results').style.display = 'none';
      document.removeEventListener('click', hideSearch);
    }
  });
}

function renderLeads(leads) {
  allLeads = leads;
  const newRequestsContainer = document.getElementById('new-requests-rows');
  if (!newRequestsContainer || !leads) return;
  
  // Filter leads by status "New Request"
  const newRequests = leads.filter(lead => lead.status === "New Request");
  
  // Update the count
  const countEl = document.getElementById('new-requests-count');
  if (countEl) countEl.textContent = newRequests.length;
  
  // Render lead cards
  const html = newRequests.map(lead => {
    const name = `${lead.first_name} ${lead.last_name}`.trim();
    const doa = lead.doa ? new Date(lead.doa).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'}) : 'TBD';
    const people = lead.people ? `${lead.people} people` : 'TBD';
    const source = lead.source || 'Unknown';
    const contextString = encodeURIComponent(`Client: ${name} | Status: ${lead.status} | DOA: ${doa} | People: ${lead.people || 'TBD'} | Phone: ${lead.phone || 'N/A'} | Total: ${lead.grand_total ? '$' + lead.grand_total : 'TBD'} | Nights: ${lead.nights || '?'} | Accommodation: ${lead.accommodation || 'TBD'} | Notes: ${(lead.notes||'').substring(0,200)}`);
    
    // Calculate time since created
    const created = lead.created_on ? new Date(lead.created_on) : null;
    let timeAgo = 'recently';
    if (created) {
      const now = new Date();
      const diffMs = now - created;
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      if (diffDays === 0) timeAgo = 'today';
      else if (diffDays === 1) timeAgo = 'yesterday';
      else if (diffDays < 7) timeAgo = `${diffDays} days ago`;
      else if (diffDays < 30) timeAgo = `${Math.floor(diffDays/7)} weeks ago`;
      else timeAgo = `${Math.floor(diffDays/30)} months ago`;
    }
    
    const phone = lead.phone || '';
    const defaultMsg = `Hey ${lead.first_name}! This is Oren at Connected Montreal, got your request let me know when you're free to talk about the trip.`;
    const notes = lead.notes ? lead.notes.trim() : '';
    const flag = lead.flag || '';
    const phoneDisplay = lead.phone || '‚Äî';
    const qqDoa = lead.doa ? (()=>{ const d=new Date(lead.doa); return String(d.getMonth()+1).padStart(2,'0')+'/'+String(d.getDate()).padStart(2,'0')+'/'+d.getFullYear(); })() : '';
    const qqUrl = 'https://airtable.com/appHT9Re4l53GO16t/shriG53J9mKJvNZ2a?prefill_Contact='+encodeURIComponent(name)+'&prefill_DOAText='+encodeURIComponent(qqDoa)+'&prefill_Nights='+(lead.nights||2)+'&prefill_People='+(lead.people||'')+'&prefill_CreateEssentialServices=Yes';
    return `
      <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 12px; margin-bottom: 8px;" class="lead-card">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:6px;">
          <div style="font-weight:700; color:#fff; font-size:13px; cursor:pointer;" onclick="toggleExpand('${lead.id}')">${flag ? flag + ' ' : ''}${name} <span id="expand-arrow-${lead.id}" style="font-size:10px;color:#666;margin-left:4px;">‚ñº</span></div>
          <div style="display:flex;gap:4px;align-items:center;">
            <a href="https://airtable.com/appHT9Re4l53GO16t/tbl4P7tqdonXv5vcY/${lead.id}" target="_blank" title="Open in Airtable" style="background:none;border:none;cursor:pointer;font-size:14px;padding:2px 4px;line-height:1;text-decoration:none;color:#aaa;">‚Üó</a>
            <a href="${qqUrl}" target="_blank" title="Quick Quote" style="background:rgba(251,191,36,0.15);border:1px solid rgba(251,191,36,0.3);border-radius:3px;color:#fbbf24;font-size:9px;font-weight:700;padding:2px 5px;line-height:1.6;text-decoration:none;letter-spacing:0.5px;">QQ</a>
            <button onclick="generateQuoteLink('${lead.id}')" title="Generate Quote Link" style="background:none;border:none;cursor:pointer;font-size:15px;padding:2px 4px;line-height:1;">üîó</button>
            <button onclick="openItinerary('${lead.id}')" title="View Itinerary" style="background:none;border:none;cursor:pointer;font-size:15px;padding:2px 4px;line-height:1;">üìÅ</button>
            <button onclick="toggleJay('${lead.id}')" title="Ask Jay" style="background:none;border:none;cursor:pointer;font-size:16px;padding:2px 4px;line-height:1;">ü§ñ</button>
            <button onclick="toggleSMS('${lead.id}', '${phone}')" title="Send SMS" style="background:none;border:none;cursor:pointer;font-size:16px;padding:2px 4px;line-height:1;">üí¨</button>
          </div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:11px; color:#aaa; margin-bottom:6px;">
          <div>üìÖ <span style="color:#4ade80;">${doa}</span></div>
          <div>üë• <span style="color:#4ade80;">${people}</span></div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:11px; color:#888;">
          <div>üìã ${source}</div>
          <div>‚è∞ ${timeAgo}</div>
        </div>
        <div style="margin-top:6px;">
          <select onchange="updateStatus('${lead.id}', this.value, this)" style="background:#1a1a2e;border:1px solid rgba(255,255,255,0.15);border-radius:4px;color:#aaa;padding:3px 6px;font-size:10px;cursor:pointer;width:100%;">
            <option value="New Request" ${lead.status==='New Request'?'selected':''}>üîµ New Request</option>
            <option value="talked to/ quoted" ${lead.status==='talked to/ quoted'?'selected':''}>üü° Talked / Quoted</option>
            <option value="Booked - Deposit" ${lead.status==='Booked - Deposit'?'selected':''}>üü¢ Booked - Deposit</option>
            <option value="Booked - Payment In Progress" ${lead.status==='Booked - Payment In Progress'?'selected':''}>üü¢ Booked - Payment In Progress</option>
            <option value="Booked - Payment Complete" ${lead.status==='Booked - Payment Complete'?'selected':''}>üü¢ Booked - Payment Complete</option>
            <option value="No Go - Coming to Town" ${lead.status==='No Go - Coming to Town'?'selected':''}>üî¥ No Go - Coming to Town</option>
            <option value="No Go - Not Coming to Town" ${lead.status==='No Go - Not Coming to Town'?'selected':''}>üî¥ No Go - Not Coming to Town</option>
            <option value="Past" ${lead.status==='Past'?'selected':''}>‚ö´ Past</option>
            <option value="Attendee Only" ${lead.status==='Attendee Only'?'selected':''}>üü£ Attendee Only</option>
            <option value="AirBNB Only" ${lead.status==='AirBNB Only'?'selected':''}>üü† AirBNB Only</option>
          </select>
          <span id="status-feedback-${lead.id}" style="font-size:10px;color:#aaa;margin-left:4px;"></span>
        </div>
        <div id="expand-${lead.id}" data-record-id="${lead.id}" data-client-name="${name}" style="display:none; margin-top:10px; border-top:1px solid rgba(255,255,255,0.08); padding-top:10px;">
          <div style="font-size:11px;color:#aaa;margin-bottom:8px;">üìû <span style="color:#fff;">${phoneDisplay}</span></div>
          ${notes ? `<div style="font-size:11px;color:#ccc;line-height:1.5;white-space:pre-wrap;">${notes.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>` : '<div style="font-size:11px;color:#555;font-style:italic;">No notes provided.</div>'}
          <div id="itinerary-${lead.id}"></div>
        </div>
        <div id="sms-${lead.id}" style="display:none; margin-top:10px; border-top:1px solid rgba(255,255,255,0.1); padding-top:10px;">
          <div id="sms-thread-${lead.id}" style="max-height:220px; overflow-y:auto; margin-bottom:8px; display:flex; flex-direction:column; gap:4px; padding:4px 0;">
            <div style="text-align:center; color:#555; font-size:10px; font-style:italic;">Loading conversation...</div>
          </div>
          <div style="display:flex; gap:6px; align-items:flex-end;">
            <input id="sms-text-${lead.id}" type="text" placeholder="${defaultMsg || 'Type a message...'}" style="flex:1; background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.2); border-radius:18px; color:#fff; padding:8px 12px; font-size:12px;" onkeydown="if(event.key==='Enter') sendSMS('${lead.id}','${phone}')"/>
            <button onclick="sendSMS('${lead.id}','${phone}')" style="background:#4ade80; border:none; border-radius:50%; color:#000; width:32px; height:32px; font-size:16px; cursor:pointer; flex-shrink:0; display:flex; align-items:center; justify-content:center;">‚Üë</button>
          </div>
          <span id="sms-status-${lead.id}" style="font-size:10px; color:#aaa; margin-top:4px; display:block;"></span>
        </div>
        <div id="jay-${lead.id}" style="display:none; margin-top:10px; border-top:1px solid rgba(99,102,241,0.3); padding-top:10px;">
          <div style="font-size:10px;color:#6366f1;font-weight:600;margin-bottom:6px;text-transform:uppercase;letter-spacing:1px;">ü§ñ Jay ‚Äî Connected Montreal AI</div>
          <div id="jay-msgs-${lead.id}" style="max-height:180px;overflow-y:auto;margin-bottom:8px;display:flex;flex-direction:column;gap:5px;"></div>
          <div style="display:flex;gap:6px;">
            <input id="jay-input-${lead.id}" type="text" placeholder="Ask Jay about this client..." style="flex:1;background:rgba(99,102,241,0.1);border:1px solid rgba(99,102,241,0.3);border-radius:4px;color:#fff;padding:6px 8px;font-size:11px;" onkeydown="if(event.key==='Enter')askJay('${lead.id}', decodeURIComponent('${contextString}'))"/>
            <button onclick="askJay('${lead.id}', decodeURIComponent('${contextString}'))" style="background:#6366f1;border:none;border-radius:4px;color:#fff;padding:6px 10px;font-size:11px;font-weight:700;cursor:pointer;">Ask</button>
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  if (html) {
    newRequestsContainer.innerHTML = html;
  }

  // Follow-ups Needed ‚Äî "talked to/ quoted"
  const followupsContainer = document.getElementById('leads-list-rows');
  if (followupsContainer) {
    const followups = leads
      .filter(lead => lead.status === 'talked to/ quoted')
      .sort((a, b) => new Date(b.status_updated || 0) - new Date(a.status_updated || 0));
    document.getElementById('followup-count').textContent = followups.length;

    const followHtml = followups.map(lead => {
      const name = `${lead.first_name} ${lead.last_name}`.trim();
      const flag = lead.flag || '';
      const doa = lead.doa ? new Date(lead.doa).toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'}) : 'TBD';
      const people = lead.people ? `${lead.people}p` : '?';
      const phone = lead.phone || '';
      const statusUpdated = lead.status_updated ? new Date(lead.status_updated) : null;
      let quotedAgo = '?';
      if (statusUpdated) {
        const diff = Math.floor((new Date() - statusUpdated) / (1000*60*60*24));
        quotedAgo = diff === 0 ? 'today' : diff === 1 ? '1d ago' : `${diff}d ago`;
      }
      const grandTotal = lead.grand_total ? `$${Number(lead.grand_total).toLocaleString('en-US', {minimumFractionDigits:0, maximumFractionDigits:0})}` : '‚Äî';
      const contextString = encodeURIComponent(`Client: ${name} | Status: ${lead.status} | DOA: ${doa} | People: ${lead.people || '?'} | Phone: ${lead.phone || 'N/A'} | Total: ${grandTotal} | Nights: ${lead.nights || '?'} | Accommodation: ${lead.accommodation || 'TBD'} | Notes: ${(lead.notes||'').substring(0,200)}`);
      return `
        <div style="background: rgba(255,255,255,0.04); border: 1px solid rgba(255,107,107,0.2); border-radius: 6px; padding: 10px; margin-bottom: 6px;" class="lead-card">
          <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:4px;">
            <div style="font-weight:700; color:#fff; font-size:13px; cursor:pointer;" onclick="toggleExpand('fu-${lead.id}')">${flag ? flag + ' ' : ''}${name} <span id="expand-arrow-fu-${lead.id}" style="font-size:10px;color:#666;margin-left:4px;">‚ñº</span></div>
            <div style="display:flex;gap:4px;align-items:center;">
              <a href="https://airtable.com/appHT9Re4l53GO16t/tbl4P7tqdonXv5vcY/${lead.id}" target="_blank" title="Open in Airtable" style="color:#aaa;text-decoration:none;font-size:14px;padding:2px 4px;">‚Üó</a>
              <button onclick="generateQuoteLink('${lead.id}')" title="Generate Quote Link" style="background:none;border:none;cursor:pointer;font-size:15px;padding:2px 4px;line-height:1;">üîó</button>
              <button onclick="openItinerary('${lead.id}')" title="View Itinerary" style="background:none;border:none;cursor:pointer;font-size:15px;padding:2px 4px;line-height:1;">üìÅ</button>
              <button onclick="toggleJay('fu-${lead.id}')" title="Ask Jay" style="background:none;border:none;cursor:pointer;font-size:16px;padding:2px 4px;line-height:1;">ü§ñ</button>
              <button onclick="toggleSMS('followup-${lead.id}', '${phone}')" title="Send SMS" style="background:none;border:none;cursor:pointer;font-size:16px;padding:2px 4px;line-height:1;">üí¨</button>
            </div>
          </div>
          <div style="display:flex; gap:10px; font-size:11px; color:#aaa;">
            <span>üìÖ <span style="color:#4ade80">${doa}</span></span>
            <span>üë• ${people}</span>
            <span style="color:#ff6b6b">‚è∞ quoted ${quotedAgo}</span>
          </div>
          <div style="margin-top:6px;">
            <select onchange="updateStatus('${lead.id}', this.value, this)" style="background:#1a1a2e;border:1px solid rgba(255,255,255,0.15);border-radius:4px;color:#aaa;padding:3px 6px;font-size:10px;cursor:pointer;width:100%;">
              <option value="New Request" ${lead.status==='New Request'?'selected':''}>üîµ New Request</option>
              <option value="talked to/ quoted" ${lead.status==='talked to/ quoted'?'selected':''}>üü° Talked / Quoted</option>
              <option value="Booked - Deposit" ${lead.status==='Booked - Deposit'?'selected':''}>üü¢ Booked - Deposit</option>
              <option value="Booked - Payment In Progress" ${lead.status==='Booked - Payment In Progress'?'selected':''}>üü¢ Booked - Payment In Progress</option>
              <option value="Booked - Payment Complete" ${lead.status==='Booked - Payment Complete'?'selected':''}>üü¢ Booked - Payment Complete</option>
              <option value="No Go - Coming to Town" ${lead.status==='No Go - Coming to Town'?'selected':''}>üî¥ No Go - Coming to Town</option>
              <option value="No Go - Not Coming to Town" ${lead.status==='No Go - Not Coming to Town'?'selected':''}>üî¥ No Go - Not Coming to Town</option>
              <option value="Past" ${lead.status==='Past'?'selected':''}>‚ö´ Past</option>
              <option value="Attendee Only" ${lead.status==='Attendee Only'?'selected':''}>üü£ Attendee Only</option>
              <option value="AirBNB Only" ${lead.status==='AirBNB Only'?'selected':''}>üü† AirBNB Only</option>
            </select>
            <span id="status-feedback-${lead.id}" style="font-size:10px;color:#aaa;margin-left:4px;"></span>
          </div>
          <div id="expand-fu-${lead.id}" data-record-id="${lead.id}" data-client-name="${name}" style="display:none; margin-top:8px; border-top:1px solid rgba(255,255,255,0.08); padding-top:8px; font-size:11px;">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:8px;">
              <div style="color:#aaa;">üìû <span style="color:#fff;">${phone || '‚Äî'}</span></div>
              <div style="color:#aaa;">üåô <span style="color:#fff;">${lead.nights ? lead.nights + ' nights' : '‚Äî'}</span></div>
              <div style="color:#aaa;">üè† <span style="color:#fff;">${lead.accommodation || '‚Äî'}</span></div>
              <div style="color:#aaa;">üéØ <span style="color:#fff;">${lead.services ? 'Set ' + lead.services : '‚Äî'}</span></div>
            </div>
            <div id="itinerary-fu-${lead.id}"></div>
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:8px;background:rgba(255,255,255,0.04);border-radius:4px;padding:8px;">
              <div style="text-align:center;">
                <div style="color:#666;font-size:9px;text-transform:uppercase;letter-spacing:1px;">Total</div>
                <div style="color:#4ade80;font-weight:700;font-size:13px;">${grandTotal}</div>
              </div>
              <div style="text-align:center;">
                <div style="color:#666;font-size:9px;text-transform:uppercase;letter-spacing:1px;">Paid</div>
                <div style="color:#fff;font-weight:700;font-size:13px;">${lead.amount_paid ? '$' + Number(lead.amount_paid).toLocaleString('en-US',{maximumFractionDigits:0}) : '‚Äî'}</div>
              </div>
              <div style="text-align:center;">
                <div style="color:#666;font-size:9px;text-transform:uppercase;letter-spacing:1px;">Balance</div>
                <div style="color:${lead.balance > 0 ? '#fbbf24' : '#4ade80'};font-weight:700;font-size:13px;">${lead.balance ? '$' + Number(lead.balance).toLocaleString('en-US',{maximumFractionDigits:0}) : '‚Äî'}</div>
              </div>
            </div>
            ${lead.next_action ? `<div style="background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.2);border-radius:4px;padding:6px;margin-bottom:6px;">‚ö° <span style="color:#fbbf24;">${lead.next_action}</span></div>` : ''}
            ${lead.crm_notes ? `<div style="color:#999;line-height:1.4;margin-bottom:4px;white-space:pre-wrap;">${lead.crm_notes.replace(/</g,'&lt;')}</div>` : ''}
            ${lead.last_followup ? `<div style="color:#666;font-size:10px;">Last follow-up: ${new Date(lead.last_followup).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}</div>` : ''}
          </div>
          <div id="sms-followup-${lead.id}" style="display:none; margin-top:10px; border-top:1px solid rgba(255,255,255,0.1); padding-top:10px;">
            <div id="sms-thread-followup-${lead.id}" style="max-height:220px; overflow-y:auto; margin-bottom:8px; display:flex; flex-direction:column; gap:4px; padding:4px 0;">
              <div style="text-align:center; color:#555; font-size:10px; font-style:italic;">Loading conversation...</div>
            </div>
            <div style="display:flex; gap:6px; align-items:flex-end;">
              <input id="sms-text-followup-${lead.id}" type="text" placeholder="Type a message..." style="flex:1; background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.2); border-radius:18px; color:#fff; padding:8px 12px; font-size:12px;" onkeydown="if(event.key==='Enter') sendSMS('followup-${lead.id}','${phone}')"/>
              <button onclick="sendSMS('followup-${lead.id}','${phone}')" style="background:#4ade80; border:none; border-radius:50%; color:#000; width:32px; height:32px; font-size:16px; cursor:pointer; flex-shrink:0; display:flex; align-items:center; justify-content:center;">‚Üë</button>
            </div>
            <span id="sms-status-followup-${lead.id}" style="font-size:10px; color:#aaa; margin-top:4px; display:block;"></span>
          </div>
          <div id="jay-fu-${lead.id}" style="display:none; margin-top:10px; border-top:1px solid rgba(99,102,241,0.3); padding-top:10px;">
            <div style="font-size:10px;color:#6366f1;font-weight:600;margin-bottom:6px;text-transform:uppercase;letter-spacing:1px;">ü§ñ Jay ‚Äî Connected Montreal AI</div>
            <div id="jay-msgs-fu-${lead.id}" style="max-height:180px;overflow-y:auto;margin-bottom:8px;display:flex;flex-direction:column;gap:5px;"></div>
            <div style="display:flex;gap:6px;">
              <input id="jay-input-fu-${lead.id}" type="text" placeholder="Ask Jay about this client..." style="flex:1;background:rgba(99,102,241,0.1);border:1px solid rgba(99,102,241,0.3);border-radius:4px;color:#fff;padding:6px 8px;font-size:11px;" onkeydown="if(event.key==='Enter')askJay('fu-${lead.id}', decodeURIComponent('${contextString}'))"/>
              <button onclick="askJay('fu-${lead.id}', decodeURIComponent('${contextString}'))" style="background:#6366f1;border:none;border-radius:4px;color:#fff;padding:6px 10px;font-size:11px;font-weight:700;cursor:pointer;">Ask</button>
            </div>
          </div>
        </div>
      `;
    }).join('');
    followupsContainer.innerHTML = followHtml || '<div style="color:#666;font-size:12px">No follow-ups pending</div>';
  }
}


function toggleExpand(id) {
  const el = document.getElementById('expand-' + id);
  const arrow = document.getElementById('expand-arrow-' + id);
  const open = el.style.display === 'none';
  el.style.display = open ? 'block' : 'none';
  if (arrow) arrow.textContent = open ? '‚ñ≤' : '‚ñº';
  if (open && el.dataset.recordId && !el.dataset.loaded) {
    el.dataset.loaded = 'true';
    loadClientItinerary(id, el.dataset.recordId, el.dataset.clientName || '');
  }
}

async function loadClientItinerary(expandId, recordId, clientName) {
  const container = document.getElementById('itinerary-' + expandId);
  if (!container) return;
  container.innerHTML = '<div style="color:#555;font-size:10px;font-style:italic;margin-top:8px;">Loading itinerary...</div>';
  try {
    const r = await fetch('/api/client-events?id=' + encodeURIComponent(recordId) + (clientName ? '&name=' + encodeURIComponent(clientName) : ''));
    const d = await r.json();
    if (!d.ok || !d.events.length) { container.innerHTML = ''; return; }
    const days = {};
    for (const ev of d.events) {
      if (!days[ev.day]) days[ev.day] = { date: ev.date, events: [] };
      days[ev.day].events.push(ev);
    }
    const sortedDays = Object.keys(days).map(Number).sort((a, b) => a - b);
    let html = '<div style="margin-top:6px;margin-bottom:6px;border-top:1px solid rgba(255,255,255,0.08);padding-top:6px;">';
    for (const dayNum of sortedDays) {
      const { date, events } = days[dayNum];
      const dateLabel = date ? new Date(date + 'T12:00:00').toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'}) : '';
      html += `<div style="margin-bottom:4px;">
        <div style="font-size:9px;font-weight:700;color:#6366f1;text-transform:uppercase;letter-spacing:1px;margin-bottom:2px;">Day ${dayNum + 1}${dateLabel ? ' ¬∑ ' + dateLabel : ''}</div>`;
      for (const ev of events) {
        const dot = ev.confirmed === 'Yes' ? '<span style="color:#4ade80;font-size:7px;margin-left:3px;">‚óè</span>'
                  : ev.confirmed === 'No'  ? '<span style="color:#ff6b6b;font-size:7px;margin-left:3px;">‚óè</span>' : '';
        const price = ev.total ? `<span style="color:#4ade80;font-size:10px;margin-left:auto;flex-shrink:0;">$${Number(ev.total).toLocaleString('en-US',{maximumFractionDigits:0})}</span>` : '';
        html += `<div style="display:flex;align-items:center;gap:5px;padding:1px 0;line-height:1.3;">
          <span style="font-size:9px;color:#666;width:48px;flex-shrink:0;">${ev.start_time || '‚Äî'}</span>
          <span style="font-size:10px;color:#ccc;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${ev.name}${dot}</span>
          ${(() => {
            const qty = ev.quantity;
            const qt = (ev.quantity_type || '').toLowerCase();
            const hrs = ev.duration > 0 ? Math.round(ev.duration / 60 * 2) / 2 : 0;
            const hStr = hrs > 0 ? `${hrs}h` : '';
            if (qt.includes('performer') || qt.includes('girl') || qt.includes('host')) {
              const gStr = qty > 0 ? `${qty}g` : '';
              const badge = [gStr, hStr].filter(Boolean).join('¬∑');
              return badge ? `<span style="font-size:9px;color:#a78bfa;flex-shrink:0;">${badge}</span>` : '';
            } else if (qt.includes('bottle') || qt.includes('hourly')) {
              return qty > 1 ? `<span style="font-size:9px;color:#888;flex-shrink:0;">√ó${qty}</span>` : '';
            } else if (hStr) {
              return `<span style="font-size:9px;color:#888;flex-shrink:0;">${hStr}</span>`;
            }
            return '';
          })()}
          ${price}
        </div>`;
      }
      html += '</div>';
    }
    html += '</div>';
    container.innerHTML = html;
  } catch(e) { container.innerHTML = ''; }
}

async function toggleSMS(id, phone) {
  const el = document.getElementById('sms-' + id);
  if (!el) return;
  const isOpening = el.style.display === 'none';
  el.style.display = isOpening ? 'block' : 'none';
  if (isOpening && phone) {
    await loadSMSThread(id, phone);
    const thread = document.getElementById('sms-thread-' + id);
    if (thread) thread.scrollTop = thread.scrollHeight;
    const input = document.getElementById('sms-text-' + id);
    if (input) input.focus();
  }
}

async function loadSMSThread(id, phone) {
  const thread = document.getElementById('sms-thread-' + id);
  if (!thread || !phone) return;
  thread.innerHTML = '<div style="text-align:center;color:#555;font-size:10px;font-style:italic;">Loading...</div>';
  try {
    const r = await fetch('/api/sms-history?to=' + encodeURIComponent(phone));
    const d = await r.json();
    if (!d.ok || !d.found || !d.messages.length) {
      thread.innerHTML = '<div style="text-align:center;color:#555;font-size:10px;font-style:italic;">No messages yet.</div>';
      return;
    }
    thread.innerHTML = d.messages.map(m => {
      const isMe = m.sender === 'me';
      const time = m.timestamp ? new Date(m.timestamp).toLocaleTimeString('en-US', {hour:'numeric',minute:'2-digit'}) : '';
      return `<div style="display:flex; flex-direction:column; align-items:${isMe ? 'flex-end' : 'flex-start'}; margin-bottom:2px;">
        <span style="background:${isMe ? '#4ade80' : 'rgba(255,255,255,0.12)'}; color:${isMe ? '#000' : '#e0e0e0'}; padding:6px 10px; border-radius:${isMe ? '14px 14px 4px 14px' : '14px 14px 14px 4px'}; font-size:11px; max-width:85%; word-wrap:break-word;">${m.text.replace(/</g,'&lt;')}</span>
        ${time ? `<span style="font-size:9px;color:#555;margin-top:1px;">${time}</span>` : ''}
      </div>`;
    }).join('');
    thread.scrollTop = thread.scrollHeight;
  } catch(e) {
    thread.innerHTML = '<div style="text-align:center;color:#ff6b6b;font-size:10px;">Failed to load</div>';
  }
}

// Jay chat ‚Äî localStorage persistence, max 4 messages sent as context
function jayLoad(id) {
  try { return JSON.parse(localStorage.getItem('jay-' + id) || '[]'); } catch(e) { return []; }
}
function jaySave(id, history) {
  try { localStorage.setItem('jay-' + id, JSON.stringify(history)); } catch(e) {}
}
function jayRenderHistory(id) {
  const msgs = document.getElementById('jay-msgs-' + id);
  if (!msgs) return;
  const history = jayLoad(id);
  if (!history.length) { msgs.innerHTML = '<div style="text-align:center;color:#555;font-size:10px;font-style:italic;">No conversation yet.</div>'; return; }
  msgs.innerHTML = history.map(h => {
    const isOren = h.role === 'oren';
    return `<div style="text-align:${isOren?'right':'left'};margin-bottom:2px;">
      <span style="background:${isOren?'rgba(99,102,241,0.3)':'rgba(255,255,255,0.08)'};color:${isOren?'#c7d2fe':'#e0e0e0'};padding:4px 8px;border-radius:8px;font-size:11px;display:inline-block;max-width:85%;white-space:pre-wrap;">${h.text.replace(/</g,'&lt;')}</span>
    </div>`;
  }).join('');
  msgs.scrollTop = msgs.scrollHeight;
}

async function openItinerary(recordId) {
  try {
    const r = await fetch('/api/show-itinerary', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({id: recordId})
    });
    const d = await r.json();
    if (d.ok) {
      window.open('https://airtable.com/appHT9Re4l53GO16t/tblLuq2c0C405bP3g/viwmSmu8oDNC2zDNX?blocks=hide', '_blank');
    } else {
      alert('Could not enable itinerary: ' + (d.error || 'Unknown error'));
    }
  } catch(e) {
    alert('Network error');
  }
}

function toggleJay(id) {
  const el = document.getElementById('jay-' + id);
  if (!el) return;
  const opening = el.style.display === 'none';
  el.style.display = opening ? 'block' : 'none';
  if (opening) {
    jayRenderHistory(id);
    const input = document.getElementById('jay-input-' + id);
    if (input) input.focus();
    const msgs = document.getElementById('jay-msgs-' + id);
    if (msgs) msgs.scrollTop = msgs.scrollHeight;
  }
}

async function askJay(id, context) {
  const input = document.getElementById('jay-input-' + id);
  const msgs = document.getElementById('jay-msgs-' + id);
  if (!input || !msgs) return;
  const message = input.value.trim();
  if (!message) return;
  input.value = '';

  const history = jayLoad(id);
  // Append user message to UI immediately
  msgs.innerHTML += `<div style="text-align:right;margin-bottom:2px;"><span style="background:rgba(99,102,241,0.3);color:#c7d2fe;padding:4px 8px;border-radius:8px;font-size:11px;display:inline-block;max-width:85%;">${message.replace(/</g,'&lt;')}</span></div>`;
  const typingId = 'jt-' + id + '-' + Date.now();
  msgs.innerHTML += `<div id="${typingId}"><span style="background:rgba(255,255,255,0.06);color:#888;padding:4px 8px;border-radius:8px;font-size:11px;font-style:italic;">Jay is thinking...</span></div>`;
  msgs.scrollTop = msgs.scrollHeight;

  // Only send last 4 entries (2 exchanges) to avoid bloating context
  const recentHistory = history.slice(-4);

  try {
    const r = await fetch('/api/ask-jay', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ context, message, history: recentHistory })
    });
    const d = await r.json();
    document.getElementById(typingId)?.remove();
    if (d.ok) {
      history.push({role:'oren', text: message});
      history.push({role:'jay', text: d.response});
      jaySave(id, history);
      msgs.innerHTML += `<div style="text-align:left;margin-bottom:2px;"><span style="background:rgba(255,255,255,0.08);color:#e0e0e0;padding:4px 8px;border-radius:8px;font-size:11px;display:inline-block;max-width:85%;white-space:pre-wrap;">${d.response.replace(/</g,'&lt;')}</span></div>`;
    } else {
      msgs.innerHTML += `<div style="color:#ff6b6b;font-size:10px;padding:4px;">‚ùå ${(d.error||'Failed').replace(/</g,'&lt;')}</div>`;
    }
    msgs.scrollTop = msgs.scrollHeight;
  } catch(e) {
    document.getElementById(typingId)?.remove();
    msgs.innerHTML += `<div style="color:#ff6b6b;font-size:10px;padding:4px;">‚ùå Network error</div>`;
    msgs.scrollTop = msgs.scrollHeight;
  }
}

async function sendSMS(id, phone) {
  const input = document.getElementById('sms-text-' + id);
  const status = document.getElementById('sms-status-' + id);
  const thread = document.getElementById('sms-thread-' + id);
  const msg = input ? input.value.trim() : '';
  if (!phone) { if(status) { status.textContent = '‚ùå No phone number'; status.style.color='#ff6b6b'; } return; }
  if (!msg) return;
  if (status) { status.textContent = 'Sending...'; status.style.color = '#aaa'; }
  if (input) input.value = '';
  try {
    const r = await fetch('/api/send-sms', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({to: phone, message: msg})
    });
    const d = await r.json();
    if (d.ok) {
      if (status) { status.textContent = '‚úÖ Sent!'; setTimeout(() => { if(status) status.textContent=''; }, 2000); }
      // Append sent message immediately
      if (thread) {
        thread.innerHTML += `<div style="display:flex;flex-direction:column;align-items:flex-end;margin-bottom:2px;"><span style="background:#4ade80;color:#000;padding:6px 10px;border-radius:14px 14px 4px 14px;font-size:11px;max-width:85%;word-wrap:break-word;">${msg.replace(/</g,'&lt;')}</span></div>`;
        thread.scrollTop = thread.scrollHeight;
      }
    } else {
      if (status) { status.textContent = '‚ùå ' + (d.error || 'Failed'); status.style.color = '#ff6b6b'; }
      if (input) input.value = msg;
    }
  } catch(e) {
    if (status) { status.textContent = '‚ùå Network error'; status.style.color = '#ff6b6b'; }
    if (input) input.value = msg;
  }
}

async function updateStatus(id, status, selectEl) {
  const feedback = document.getElementById('status-feedback-' + id);
  if (feedback) { feedback.textContent = 'Saving...'; feedback.style.color = '#aaa'; }
  try {
    const r = await fetch('/api/update-status', {
      method: 'PATCH',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({id, status})
    });
    const d = await r.json();
    if (d.ok) {
      if (feedback) { feedback.textContent = '‚úÖ'; setTimeout(() => { feedback.textContent = ''; }, 2000); }
    } else {
      if (feedback) { feedback.textContent = '‚ùå ' + (d.error || 'Failed'); feedback.style.color = '#ff6b6b'; }
    }
  } catch(e) {
    if (feedback) { feedback.textContent = '‚ùå Error'; feedback.style.color = '#ff6b6b'; }
  }
}

function renderTraffic() {
  document.getElementById('total-pageviews').textContent = DAILY_REPORT.posthog.total_pageviews_7d;
  document.getElementById('avg-pageviews').textContent = DAILY_REPORT.posthog.avg_daily_pageviews.toFixed(1);
  
  // Traffic sources - render all items but collapsed by default
  const allSources = expandableData.sources;
  const maxSessions = Math.max(...allSources.map(s => s.sessions));
  const sourcesHtml = allSources.map(s => {
    const displayName = s.source.replace('www.', '').replace('com.google.android.', 'Android ');
    return `
      <div class="source-row">
        <div class="source-name">${displayName}</div>
        <div class="source-count">${s.sessions}</div>
      </div>
    `;
  }).join('');
  document.getElementById('sources-list').innerHTML = sourcesHtml;
  updateToggleText('sources-list');
  
  // Top pages - render all items but collapsed by default
  const allPages = expandableData.pages;
  const pagesHtml = allPages.map(p => {
    const url = p.url.length > 35 ? p.url.substring(0, 32) + '‚Ä¶' : p.url;
    return `
      <div class="source-row">
        <div class="source-name">${url}</div>
        <div class="source-count">${p.views}</div>
      </div>
    `;
  }).join('');
  document.getElementById('top-pages-list').innerHTML = pagesHtml;
  updateToggleText('top-pages-list');
  
  // Ad landing pages - render all items but collapsed by default
  const allAdPages = expandableData.adPages;
  const adHtml = allAdPages.map(p => {
    const url = p.url.length > 35 ? p.url.substring(0, 32) + '‚Ä¶' : p.url;
    return `
      <div class="source-row">
        <div class="source-name">${url}</div>
        <div class="source-count">${p.views}</div>
      </div>
    `;
  }).join('');
  document.getElementById('ad-pages-list').innerHTML = adHtml;
  updateToggleText('ad-pages-list');
}

function toggleList(listId) {
  const listElement = document.getElementById(listId);
  const isCollapsed = listElement.classList.contains('collapsed');
  
  if (isCollapsed) {
    listElement.classList.remove('collapsed');
    listElement.classList.add('expanded');
  } else {
    listElement.classList.remove('expanded');
    listElement.classList.add('collapsed');
  }
  
  updateToggleText(listId);
}

function updateToggleText(listId) {
  const listElement = document.getElementById(listId);
  const isCollapsed = listElement.classList.contains('collapsed');
  const rowCount = listElement.querySelectorAll('.source-row').length;
  
  // Find the toggle button for this list
  const toggleButton = listElement.closest('.sources-list').querySelector('.list-toggle');
  const toggleText = toggleButton.querySelector('span:last-child');
  const toggleIcon = toggleButton.querySelector('.toggle-icon');
  
  if (isCollapsed) {
    toggleText.textContent = `Show more (${rowCount})`;
    toggleIcon.textContent = '‚ñº';
  } else {
    toggleText.textContent = 'Show less';
    toggleIcon.textContent = '‚ñ≤';
  }
}

function renderInsights() {
  // Opportunities
  const oppsHtml = DAILY_REPORT.insights.opportunities.map(opp => {
    return `
      <div class="insight-card opportunity">
        <div class="insight-text"><span class="insight-icon">‚úì</span> ${opp}</div>
      </div>
    `;
  }).join('');
  document.getElementById('opportunities-list').innerHTML = oppsHtml;
  
  // Issues
  const issuesHtml = DAILY_REPORT.insights.issues.map(issue => {
    const isAlert = issue === 'No critical issues detected' ? false : true;
    const icon = isAlert ? '‚ö†Ô∏è' : '‚úì';
    const type = isAlert ? 'issue' : 'alert';
    return `
      <div class="insight-card ${type}">
        <div class="insight-text"><span class="insight-icon">${icon}</span> ${issue}</div>
      </div>
    `;
  }).join('');
  document.getElementById('issues-list').innerHTML = issuesHtml;
}

function renderTimestamp() {
  const dt = new Date('2026-02-26T13:31:17.332407');
  const timeStr = dt.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true });
  document.getElementById('generated-time').textContent = timeStr;
  
  // "Last updated: Xm ago"
  const now = new Date('2026-02-26T13:33:00');
  const minsAgo = Math.floor((now - dt) / 60000);
  document.getElementById('lastUpdatedTime').textContent = `Last updated: ${minsAgo}m ago`;
}

// PostHog API Configuration
const POSTHOG_CONFIG = {
  apiKey: 'phx_10r8mxfGxYI4gU863o057kfjjHrUPsiwpOipfPofxCRBV77P',
  host: 'https://us.posthog.com',
  projectId: '305689'
};

function getDateRange(range) {
  const today = new Date();
  const from = new Date(today);
  
  switch(range) {
    case '1d':
      from.setDate(from.getDate() - 1);
      return { date_from: '-1d', date_to: null, interval: 'day', label: '(1d)' };
    case '7d':
      from.setDate(from.getDate() - 7);
      return { date_from: '-7d', date_to: null, interval: 'day', label: '(7d)' };
    case '30d':
      from.setDate(from.getDate() - 30);
      return { date_from: '-30d', date_to: null, interval: 'day', label: '(1M)' };
    default:
      return { date_from: '-7d', date_to: null, interval: 'day', label: '(7d)' };
  }
}

function toggleCustomDateInput() {
  const customInputs = document.getElementById('custom-date-inputs');
  customInputs.classList.toggle('show');
}

async function fetchTrafficData(range) {
  const errorDiv = document.getElementById('traffic-error');
  errorDiv.classList.remove('show');
  
  // Update active button
  document.querySelectorAll('.date-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelector(`[data-range="${range}"]`).classList.add('active');
  
  // Hide custom inputs if not custom
  if (range !== 'custom') {
    document.getElementById('custom-date-inputs').classList.remove('show');
  }
  
  const dateRange = getDateRange(range);
  document.getElementById('traffic-period').textContent = dateRange.label;
  
  // Show loading state
  document.getElementById('total-pageviews').textContent = 'Loading...';
  document.getElementById('avg-pageviews').textContent = '...';
  
  try {
    // Fetch pageviews data
    const pageviewsResponse = await fetch(`${POSTHOG_CONFIG.host}/api/projects/${POSTHOG_CONFIG.projectId}/insights/trend/`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${POSTHOG_CONFIG.apiKey}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        insight: 'TRENDS',
        events: [{ id: '$pageview', type: 'events', math: 'total' }],
        date_from: dateRange.date_from,
        date_to: dateRange.date_to,
        interval: dateRange.interval
      })
    });
    
    if (!pageviewsResponse.ok) {
      throw new Error(`API error: ${pageviewsResponse.status}`);
    }
    
    const pageviewsData = await pageviewsResponse.json();
    
    // Calculate totals
    let totalPageviews = 0;
    let dayCount = 0;
    
    if (pageviewsData.results && pageviewsData.results.length > 0) {
      const series = pageviewsData.results[0].data;
      if (Array.isArray(series)) {
        series.forEach(point => {
          if (typeof point === 'object' && point.count) {
            totalPageviews += point.count;
            dayCount += 1;
          }
        });
      }
    }
    
    const avgPageviews = dayCount > 0 ? (totalPageviews / dayCount).toFixed(1) : 0;
    
    // Update UI
    document.getElementById('total-pageviews').textContent = totalPageviews || '0';
    document.getElementById('avg-pageviews').textContent = avgPageviews;
    
    // Fetch top pages
    fetchTopPages(dateRange.date_from);
    
    // Fetch traffic sources
    fetchTrafficSources(dateRange.date_from);
    
  } catch (error) {
    console.error('Traffic data fetch error:', error);
    errorDiv.textContent = `Error loading traffic data: ${error.message}`;
    errorDiv.classList.add('show');
    document.getElementById('total-pageviews').textContent = '‚Äî';
    document.getElementById('avg-pageviews').textContent = '‚Äî';
  }
}

async function fetchTopPages(dateFrom) {
  try {
    const response = await fetch(`${POSTHOG_CONFIG.host}/api/projects/${POSTHOG_CONFIG.projectId}/insights/trend/`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${POSTHOG_CONFIG.apiKey}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        insight: 'TRENDS',
        events: [{ id: '$pageview', type: 'events', math: 'total' }],
        breakdown: '$current_url',
        breakdown_type: 'event',
        date_from: dateFrom
      })
    });
    
    if (!response.ok) throw new Error(`API error: ${response.status}`);
    
    const data = await response.json();
    
    // Parse results
    let pages = [];
    if (data.results && Array.isArray(data.results)) {
      pages = data.results.map(item => ({
        url: item.breakdown_value || item.label || 'unknown',
        views: item.count || 0
      })).sort((a, b) => b.views - a.views);
    }
    
    expandableData.pages = pages;
    
    // Re-render pages list
    const allPages = expandableData.pages;
    const pagesHtml = allPages.map(p => {
      const url = p.url.length > 35 ? p.url.substring(0, 32) + '‚Ä¶' : p.url;
      return `
        <div class="source-row">
          <div class="source-name">${url}</div>
          <div class="source-count">${p.views}</div>
        </div>
      `;
    }).join('');
    document.getElementById('top-pages-list').innerHTML = pagesHtml;
    updateToggleText('top-pages-list');
    
  } catch (error) {
    console.error('Top pages fetch error:', error);
  }
}

async function fetchTrafficSources(dateFrom) {
  try {
    const response = await fetch(`${POSTHOG_CONFIG.host}/api/projects/${POSTHOG_CONFIG.projectId}/insights/trend/`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${POSTHOG_CONFIG.apiKey}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        insight: 'TRENDS',
        events: [{ id: '$pageview', type: 'events', math: 'total' }],
        breakdown: '$referring_domain',
        breakdown_type: 'event',
        date_from: dateFrom
      })
    });
    
    if (!response.ok) throw new Error(`API error: ${response.status}`);
    
    const data = await response.json();
    
    // Parse results
    let sources = [];
    if (data.results && Array.isArray(data.results)) {
      sources = data.results.map(item => ({
        source: item.breakdown_value || item.label || 'unknown',
        sessions: item.count || 0
      })).sort((a, b) => b.sessions - a.sessions);
    }
    
    expandableData.sources = sources;
    
    // Re-render sources list
    const allSources = expandableData.sources;
    const sourcesHtml = allSources.map(s => {
      const displayName = s.source.replace('www.', '').replace('com.google.android.', 'Android ');
      return `
        <div class="source-row">
          <div class="source-name">${displayName}</div>
          <div class="source-count">${s.sessions}</div>
        </div>
      `;
    }).join('');
    document.getElementById('sources-list').innerHTML = sourcesHtml;
    updateToggleText('sources-list');
    
  } catch (error) {
    console.error('Traffic sources fetch error:', error);
  }
}

function fetchTrafficDataCustom() {
  const fromInput = document.getElementById('custom-from').value;
  const toInput = document.getElementById('custom-to').value;
  
  if (!fromInput || !toInput) {
    alert('Please enter both from and to dates');
    return;
  }
  
  const errorDiv = document.getElementById('traffic-error');
  errorDiv.classList.remove('show');
  
  // Update active button
  document.querySelectorAll('.date-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelector('[data-range="custom"]').classList.add('active');
  
  document.getElementById('traffic-period').textContent = `(${fromInput} to ${toInput})`;
  
  // Show loading state
  document.getElementById('total-pageviews').textContent = 'Loading...';
  document.getElementById('avg-pageviews').textContent = '...';
  
  // Fetch with custom dates
  fetchTrafficDataWithDates(fromInput, toInput);
}

async function fetchTrafficDataWithDates(dateFrom, dateTo) {
  try {
    const pageviewsResponse = await fetch(`${POSTHOG_CONFIG.host}/api/projects/${POSTHOG_CONFIG.projectId}/insights/trend/`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${POSTHOG_CONFIG.apiKey}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        insight: 'TRENDS',
        events: [{ id: '$pageview', type: 'events', math: 'total' }],
        date_from: dateFrom,
        date_to: dateTo,
        interval: 'day'
      })
    });
    
    if (!pageviewsResponse.ok) {
      throw new Error(`API error: ${pageviewsResponse.status}`);
    }
    
    const pageviewsData = await pageviewsResponse.json();
    
    // Calculate totals
    let totalPageviews = 0;
    let dayCount = 0;
    
    if (pageviewsData.results && pageviewsData.results.length > 0) {
      const series = pageviewsData.results[0].data;
      if (Array.isArray(series)) {
        series.forEach(point => {
          if (typeof point === 'object' && point.count) {
            totalPageviews += point.count;
            dayCount += 1;
          }
        });
      }
    }
    
    const avgPageviews = dayCount > 0 ? (totalPageviews / dayCount).toFixed(1) : 0;
    
    document.getElementById('total-pageviews').textContent = totalPageviews || '0';
    document.getElementById('avg-pageviews').textContent = avgPageviews;
    
    // Fetch related data
    fetchTopPages(dateFrom);
    fetchTrafficSources(dateFrom);
    
  } catch (error) {
    const errorDiv = document.getElementById('traffic-error');
    errorDiv.textContent = `Error loading traffic data: ${error.message}`;
    errorDiv.classList.add('show');
    document.getElementById('total-pageviews').textContent = '‚Äî';
    document.getElementById('avg-pageviews').textContent = '‚Äî';
  }
}

function toggleProposals() {
  const proposalsList = document.getElementById('proposals-list');
  const toggleIcon = document.getElementById('proposals-toggle-icon');
  
  if (proposalsList.classList.contains('show')) {
    proposalsList.classList.remove('show');
    toggleIcon.textContent = '‚ñº Show';
  } else {
    proposalsList.classList.add('show');
    toggleIcon.textContent = '‚ñ≤ Hide';
  }
}

function renderProposals() {
  const proposalsList = document.getElementById('proposals-list');
  const count = PROPOSALS.proposals.length;
  document.getElementById('proposals-count').textContent = count;
  
  const proposalsHtml = PROPOSALS.proposals.map(proposal => {
    const priorityClass = proposal.priority.toLowerCase();
    const issueTruncated = proposal.issue.length > 80 ? proposal.issue.substring(0, 77) + '‚Ä¶' : proposal.issue;
    
    return `
      <div class="proposal-card ${priorityClass}">
        <div class="proposal-header">
          <div class="proposal-priority ${priorityClass}">${proposal.priority}</div>
        </div>
        <div class="proposal-issue">${issueTruncated}</div>
        <div class="proposal-action">
          <button class="proposal-btn" onclick="openProposalDetail('${proposal.id}', '${proposal.priority.toUpperCase()}', '${proposal.issue.replace(/'/g, "\\'")}', '${proposal.solution.replace(/'/g, "\\'")}')">Open ‚Üí</button>
        </div>
      </div>
    `;
  }).join('');
  
  proposalsList.innerHTML = proposalsHtml;
}

function openProposalDetail(id, priority, issue, solution) {
  const html = `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Proposal Details</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: #0a0a0f; color: #e0e0e0;
      font-family: 'SF Mono', 'JetBrains Mono', 'Fira Code', monospace;
      padding: 20px; line-height: 1.6;
    }
    .container {
      max-width: 700px; margin: 0 auto;
    }
    .header {
      display: flex; align-items: center; gap: 12px; margin-bottom: 20px;
    }
    .close-btn {
      background: #1e1e2e; color: #999; border: 1px solid #2a2a4a;
      padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;
      font-family: inherit; transition: all .2s;
    }
    .close-btn:hover {
      background: #2a2a4a; border-color: #333; color: #fff;
    }
    .priority-badge {
      display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 10px;
      font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
    }
    .priority-badge.HIGH {
      background: rgba(204,0,0,.2); color: #ff6b6b;
    }
    .priority-badge.MEDIUM {
      background: rgba(251,191,36,.2); color: #fbbf24;
    }
    .section {
      margin-bottom: 24px;
    }
    .section-title {
      font-size: 12px; font-weight: 700; text-transform: uppercase; color: #888;
      letter-spacing: 1px; margin-bottom: 10px;
    }
    .section-content {
      background: #111118; border: 1px solid #1e1e2e; border-radius: 6px;
      padding: 14px; font-size: 13px; line-height: 1.5; color: #ccc;
    }
    .actions {
      display: flex; gap: 8px; margin-top: 20px;
    }
    .action-btn {
      flex: 1; padding: 12px 16px; border-radius: 6px; font-size: 12px;
      font-weight: 600; cursor: pointer; font-family: inherit; transition: all .2s;
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    .approve-btn {
      background: #22c55e; color: #000; border: none;
    }
    .approve-btn:hover {
      background: #4ade80; box-shadow: 0 0 12px rgba(34,197,94,.3);
    }
    .dismiss-btn {
      background: #1e1e2e; color: #888; border: 1px solid #2a2a4a;
    }
    .dismiss-btn:hover {
      background: #2a2a4a; border-color: #333; color: #fff;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <span class="priority-badge ${priority}">${priority}</span>
      <button class="close-btn" onclick="window.close()">‚úï Close</button>
    </div>
    
    <div class="section">
      <div class="section-title">Issue</div>
      <div class="section-content">${issue}</div>
    </div>
    
    <div class="section">
      <div class="section-title">Recommended Solution</div>
      <div class="section-content">${solution}</div>
    </div>
    
    <div class="actions">
      <button class="action-btn approve-btn" onclick="alert('‚úì Proposal approved! (placeholder)'); window.close();">‚úì Approve & Implement</button>
      <button class="action-btn dismiss-btn" onclick="alert('‚úï Proposal dismissed (placeholder)'); window.close();">‚úï Dismiss</button>
    </div>
  </div>
</body>
</html>
  `;
  
  const blob = new Blob([html], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  window.open(url, 'proposal_detail', 'width=800,height=600,menubar=no,toolbar=no,status=no');
}

// Fetch live data from API
async function fetchLiveData() {
  try {
    const response = await fetch('/api/data');
    const data = await response.json();
    
    // Update pipeline counts if available
    if (data.pipeline) {
      document.getElementById('pipeline-new').textContent = data.pipeline.new || '0';
      document.getElementById('pipeline-quoted').textContent = data.pipeline.quoted || '0';
      document.getElementById('pipeline-booked').textContent = data.pipeline.booked || '0';
      document.getElementById('pipeline-nogo').textContent = data.pipeline.no_go || '0';
    }
    
    // Render lead cards from real data
    if (data.leads && Array.isArray(data.leads)) {
      renderLeads(data.leads);
    }
  } catch (error) {
    console.error('Error fetching live data:', error);
    // Fall back to embedded data
    renderNewRequests();
  }
}

// Initialize
renderPipeline();
renderNewRequests();
renderTraffic();
renderInsights();
renderTimestamp();
renderProposals();

// Fetch and render live lead data
fetchLiveData();

// Refresh live data every 5 minutes
setInterval(fetchLiveData, 300000);

function switchTab(name, btn) {
  document.querySelectorAll('[data-tab]').forEach(el => el.classList.remove('tab-active'));
  document.querySelectorAll('.mobile-tab-btn').forEach(b => b.classList.remove('active'));
  const panel = document.querySelector('[data-tab="' + name + '"]');
  if (panel) panel.classList.add('tab-active');
  if (btn) btn.classList.add('active');
}

// Set pipeline active on load
document.addEventListener('DOMContentLoaded', () => {
  const first = document.querySelector('[data-tab]');
  if (first) first.classList.add('tab-active');
});
</script>

<!-- Quote Link Modal -->
<div id="quote-modal-overlay" onclick="closeQuoteModal()" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:2000;align-items:center;justify-content:center;"></div>
<div id="quote-modal" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#111118;border:1px solid #2a2a3a;border-radius:12px;padding:28px;max-width:480px;width:90%;z-index:2001;box-shadow:0 20px 60px rgba(0,0,0,0.8);">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
    <div style="font-size:14px;font-weight:700;color:#fff;">üîó Quote Link Generated</div>
    <button onclick="closeQuoteModal()" style="background:none;border:none;color:#666;font-size:18px;cursor:pointer;line-height:1;padding:2px 4px;">‚úï</button>
  </div>
  <div style="margin-bottom:16px;">
    <div style="font-size:10px;letter-spacing:2px;text-transform:uppercase;color:#888;margin-bottom:6px;">Shareable Link</div>
    <div style="display:flex;gap:6px;align-items:center;">
      <input id="quote-url-field" readonly style="flex:1;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.15);border-radius:6px;color:#c9a84c;padding:10px 12px;font-size:12px;font-family:monospace;" />
      <button onclick="copyField('quote-url-field','copy-url-btn')" id="copy-url-btn" style="background:#1e1e2e;border:1px solid #2a2a4a;border-radius:6px;color:#aaa;padding:10px 14px;font-size:11px;cursor:pointer;white-space:nowrap;font-weight:600;">Copy</button>
    </div>
  </div>
  <div style="margin-bottom:24px;">
    <div style="font-size:10px;letter-spacing:2px;text-transform:uppercase;color:#888;margin-bottom:6px;">Client Password</div>
    <div style="display:flex;gap:6px;align-items:center;">
      <input id="quote-pw-field" readonly style="flex:1;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.15);border-radius:6px;color:#fff;padding:10px 12px;font-size:20px;letter-spacing:8px;font-weight:700;font-family:monospace;" />
      <button onclick="copyField('quote-pw-field','copy-pw-btn')" id="copy-pw-btn" style="background:#1e1e2e;border:1px solid #2a2a4a;border-radius:6px;color:#aaa;padding:10px 14px;font-size:11px;cursor:pointer;white-space:nowrap;font-weight:600;">Copy</button>
    </div>
  </div>
  <div style="background:rgba(201,168,76,0.08);border:1px solid rgba(201,168,76,0.2);border-radius:8px;padding:12px;font-size:11px;color:#c9a84c;line-height:1.6;margin-bottom:16px;">
    üìã <strong>Send both</strong> the link and the password to your client. The link won't work without the password.
  </div>
  <button onclick="closeQuoteModal()" style="width:100%;background:#1e1e2e;border:1px solid #2a2a4a;border-radius:6px;color:#aaa;padding:10px;font-size:12px;cursor:pointer;font-weight:600;">Done</button>
</div>

<script>
async function generateQuoteLink(recordId) {
  try {
    const r = await fetch('/api/generate-quote-link', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({record_id: recordId})
    });
    const d = await r.json();
    if (!d.ok) { alert('Failed to generate link: ' + (d.error || 'Unknown error')); return; }
    document.getElementById('quote-url-field').value = d.url;
    document.getElementById('quote-pw-field').value = d.password;
    document.getElementById('copy-url-btn').textContent = 'Copy';
    document.getElementById('copy-pw-btn').textContent = 'Copy';
    document.getElementById('quote-modal-overlay').style.display = 'flex';
    document.getElementById('quote-modal').style.display = 'block';
  } catch(e) {
    alert('Network error generating quote link.');
  }
}

function closeQuoteModal() {
  document.getElementById('quote-modal-overlay').style.display = 'none';
  document.getElementById('quote-modal').style.display = 'none';
}

function copyField(fieldId, btnId) {
  const field = document.getElementById(fieldId);
  navigator.clipboard.writeText(field.value).then(() => {
    const btn = document.getElementById(btnId);
    const orig = btn.textContent;
    btn.textContent = '‚úì Copied!';
    btn.style.color = '#4ade80';
    setTimeout(() => { btn.textContent = orig; btn.style.color = ''; }, 2000);
  }).catch(() => {
    field.select();
    document.execCommand('copy');
  });
}
</script>

<!-- Chat Panel -->
<style>
#chat-toggle{position:fixed;right:0;top:50%;transform:translateY(-50%);background:#22c55e;color:#000;border:none;padding:10px 6px;cursor:pointer;font-size:12px;font-weight:700;writing-mode:vertical-rl;border-radius:4px 0 0 4px;z-index:1000;}
#chat-panel{position:fixed;right:-340px;top:0;width:340px;height:100vh;background:#111118;border-left:1px solid #1e1e2e;display:flex;flex-direction:column;z-index:999;transition:right .3s;font-family:'SF Mono',monospace;}
#chat-panel.open{right:0;}
#chat-header{padding:12px;border-bottom:1px solid #1e1e2e;display:flex;gap:8px;align-items:center;}
#chat-header span{color:#fff;font-size:13px;font-weight:700;flex:1;}
.mode-btn{padding:4px 8px;border:1px solid #333;background:transparent;color:#888;font-size:10px;cursor:pointer;border-radius:3px;}
.mode-btn.active{background:#22c55e;color:#000;border-color:#22c55e;}
#chat-messages{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:8px;}
.msg{padding:8px 10px;border-radius:4px;font-size:11px;line-height:1.5;max-width:100%;word-wrap:break-word;}
.msg.user{background:#1e1e2e;color:#e0e0e0;align-self:flex-end;}
.msg.ai{background:#0a1a0a;color:#4ade80;border:1px solid #1a3a1a;}
.msg.error{background:#1a0a0a;color:#f87171;border:1px solid #3a1a1a;}
#chat-input-area{padding:10px;border-top:1px solid #1e1e2e;display:flex;flex-direction:column;gap:6px;}
#chat-input{width:100%;background:#0a0a0f;border:1px solid #333;color:#e0e0e0;padding:8px;font-size:11px;font-family:inherit;border-radius:3px;resize:none;height:60px;}
#chat-input:focus{outline:none;border-color:#22c55e;}
.chat-actions{display:flex;gap:6px;}
#chat-send{flex:1;background:#22c55e;color:#000;border:none;padding:6px;cursor:pointer;font-size:11px;font-weight:700;border-radius:3px;}
#chat-refresh{background:transparent;border:1px solid #333;color:#888;padding:6px 8px;cursor:pointer;font-size:11px;border-radius:3px;}
#chat-offline{display:none;padding:8px 12px;background:#1a0a0a;color:#f87171;font-size:10px;border-bottom:1px solid #3a1a1a;}
</style>

<button id="chat-toggle" onclick="document.getElementById('chat-panel').classList.toggle('open')">üí¨ Chat</button>
<div id="chat-panel">
  <div id="chat-offline">‚ö†Ô∏è Server offline ‚Äî run: cd ~/Projects/connected-montreal-ai && ./start.sh</div>
  <div id="chat-header">
    <span>üéØ AI Assistant</span>
    <button class="mode-btn active" id="btn-ollama" onclick="setMode('ollama')">ü¶ô Ollama</button>
    <button class="mode-btn" id="btn-openclaw" onclick="setMode('openclaw')">ü§ñ OpenClaw</button>
  </div>
  <div id="chat-messages"></div>
  <div id="chat-input-area">
    <textarea id="chat-input" placeholder="Ask about leads, traffic, pipeline..."></textarea>
    <div class="chat-actions">
      <button id="chat-refresh" onclick="refreshData()" title="Refresh live data">üîÑ Refresh</button>
      <button id="chat-send" onclick="sendMessage()">Send</button>
    </div>
  </div>
</div>

<script>
(function(){
  var mode = 'ollama';
  var history = [];
  var BASE = 'http://localhost:5050';

  function setMode(m){
    mode = m;
    document.getElementById('btn-ollama').classList.toggle('active', m==='ollama');
    document.getElementById('btn-openclaw').classList.toggle('active', m==='openclaw');
  }
  window.setMode = setMode;

  function addMsg(role, text){
    var div = document.createElement('div');
    div.className = 'msg ' + role;
    div.textContent = text;
    var msgs = document.getElementById('chat-messages');
    msgs.appendChild(div);
    msgs.scrollTop = msgs.scrollHeight;
    return div;
  }

  function refreshData(){
    fetch(BASE+'/api/refresh', {method:'POST'})
      .then(r=>r.json()).then(d=>{
        addMsg('ai','‚úÖ Data refreshed. Pageviews: '+(d.pageviews_7d||'?')+', Pipeline: '+JSON.stringify(d.pipeline||{}));
      }).catch(()=>addMsg('error','‚ùå Could not reach server'));
  }
  window.refreshData = refreshData;

  async function sendMessage(){
    var input = document.getElementById('chat-input');
    var msg = input.value.trim();
    if(!msg) return;
    input.value = '';
    addMsg('user', msg);
    var thinking = addMsg('ai','...');
    var endpoint = mode==='ollama' ? '/api/chat' : '/api/ask-openclaw';
    var body = mode==='ollama' ? {message:msg, history:history} : {message:msg};
    try {
      var r = await fetch(BASE+endpoint, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)});
      var data = await r.json();
      var resp = data.response || data.error || 'No response';
      thinking.textContent = resp;
      thinking.className = data.error ? 'msg error' : 'msg ai';
      if(!data.error && mode==='ollama'){
        history.push({role:'user',content:msg});
        history.push({role:'assistant',content:resp});
        if(history.length > 20) history = history.slice(-20);
      }
    } catch(e){
      thinking.textContent = '‚ùå Server offline ‚Äî run ./start.sh';
      thinking.className = 'msg error';
    }
  }
  window.sendMessage = sendMessage;

  document.getElementById('chat-input').addEventListener('keydown', function(e){
    if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }
  });

  // Check server on load
  fetch(BASE+'/api/data').then(r=>r.json()).then(d=>{
    document.getElementById('chat-offline').style.display='none';
  }).catch(()=>{
    document.getElementById('chat-offline').style.display='block';
  });
})();
</script>

</body>
</html>
